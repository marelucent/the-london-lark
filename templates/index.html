<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The London Lark</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ============================================
           SAFETY COMPONENT STYLES
           ============================================ */
        
        /* Soft Footer (Tier 2 - Emotional) */
        .safety-soft-footer {
            margin-top: 2rem;
            padding: 1rem 1.5rem;
            background: rgba(212, 175, 55, 0.05);
            border-left: 2px solid rgba(212, 175, 55, 0.3);
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.8;
        }
        
        .safety-soft-footer a {
            color: var(--gold, #d4af37);
            text-decoration: none;
        }
        
        .safety-soft-footer a:hover {
            text-decoration: underline;
        }
        
        /* Support Box (Tier 3 - Distress) */
        .safety-support-box {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(106, 106, 122, 0.15) 0%, rgba(26, 23, 20, 0.9) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }
        
        .safety-support-box .lark-says {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--cream, #f5f0e6);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .support-links {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .support-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 3px;
            color: var(--candlelight, #f4e4bc);
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .support-link:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold, #d4af37);
        }
        
        .more-link {
            color: var(--gold, #d4af37);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .more-link:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        /* Crisis Box (Tier 4 - Crisis) */
        .safety-crisis-box {
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(13, 13, 13, 0.95) 0%, rgba(26, 23, 20, 0.98) 100%);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 4px;
        }
        
        .crisis-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .crisis-icon {
            font-size: 1.5rem;
        }
        
        .crisis-title {
            font-family: var(--font-title, 'Cinzel', serif);
            font-size: 1rem;
            letter-spacing: 0.15em;
            color: var(--gold, #d4af37);
        }
        
        .safety-crisis-box .lark-says {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.15rem;
            font-style: italic;
            color: var(--cream, #f5f0e6);
            margin-bottom: 1.5rem;
            line-height: 1.7;
        }
        
        .crisis-contacts {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .crisis-contact {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 3px;
        }
        
        .contact-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .contact-name {
            font-family: var(--font-title, 'Cinzel', serif);
            font-size: 0.9rem;
            color: var(--gold, #d4af37);
            letter-spacing: 0.05em;
        }
        
        .contact-number {
            font-size: 1.1rem;
            color: var(--cream, #f5f0e6);
        }
        
        .contact-number a {
            color: var(--cream, #f5f0e6);
            text-decoration: none;
        }
        
        .contact-number a:hover {
            color: var(--gold, #d4af37);
        }
        
        .contact-note {
            font-size: 0.85rem;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.7;
        }
        
        .venue-offer {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.8;
            margin-top: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .support-links {
                flex-direction: column;
                align-items: flex-start;
            }

            .crisis-contact {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* ============================================
           ASK VIEW - CONVERSATION FIRST
           ============================================ */

        .ask-intro {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
        }

        .ask-intro-text {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.15rem;
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            line-height: 1.8;
            max-width: 500px;
            margin: 0 auto;
            opacity: 0.9;
        }

        .ask-fallback {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
        }

        .fallback-label {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 0.95rem;
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.6;
            display: block;
            margin-bottom: 1rem;
        }

        .fallback-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }

        .fallback-link {
            font-family: var(--font-title, 'Cinzel', serif);
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            color: var(--gold, #d4af37);
            text-decoration: none;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .fallback-link:hover {
            opacity: 1;
        }

        /* Placeholder fade animation */
        #userInput {
            transition: opacity 0.3s ease;
        }

        #userInput.placeholder-fade {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- HEADER - The Lark's Mark -->
        <header>
            <h1 onclick="returnToEntrance()" style="cursor: pointer;">‚ú¶ THE LONDON LARK ‚ú¶</h1>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="mainContent">
            
            <!-- ENTRANCE: Portal Moment -->
            <section id="entranceView" class="view active">
                <div class="portal-moment">
                    <p class="opening-line" id="openingLine">{{ greeting }}</p>
                    <p class="portal-question">How would you like to begin?</p>
                </div>
                
                <!-- The Three Paths -->
                <div class="paths-container">
                    <div class="path-card" onclick="choosePath('draw')">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="path-icon">‚ú¶</div>
                        <div class="path-title">DRAW A CARD</div>
                        <div class="path-whisper">"Let fate decide"</div>
                    </div>
                    
                    <div class="path-card" onclick="choosePath('ask')">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="path-icon">‚ù¶</div>
                        <div class="path-title">ASK THE LARK</div>
                        <div class="path-whisper">"Tell me what you seek"</div>
                    </div>
                    
                    <div class="path-card" onclick="choosePath('browse')">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="path-icon">‚ò∞</div>
                        <div class="path-title">BROWSE THE DECK</div>
                        <div class="path-whisper">"Lay out the cards"</div>
                    </div>
                </div>
            </section>

            <!-- DRAW A CARD VIEW -->
            <section id="drawView" class="view">
                <div class="draw-container">
                    <!-- Face-down card -->
                    <div class="arcana-card card-lg face-down" id="drawnCard" onclick="revealCard(currentArcana)">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-back-symbol">‚ú¶</div>
                        <div class="card-back-prompt">tap when you're ready</div>
                    </div>
                    
                    <!-- Revealed card (hidden initially) -->
                    <div class="arcana-card card-lg" id="revealedCard" style="display: none;">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-inner">
                            <div class="arcana-symbol" id="cardArcanaSymbol"></div>
                            <div class="arcana-number" id="cardArcanaNumber"></div>
                            <div class="arcana-name" id="cardArcanaName"></div>
                            <div class="arcana-mood" id="cardArcanaMood"></div>
                            <div class="arcana-divider"></div>
                            <div class="venue-section">
                                <div class="venue-name" id="cardVenueName"></div>
                                <div class="venue-location" id="cardVenueLocation"></div>
                                <div class="venue-blurb" id="cardVenueBlurb"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Draw actions -->
                <div class="draw-actions" id="drawActions" style="display: none;">
                    <button class="action-btn" onclick="drawAnother()">Draw Another</button>
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back</button>
                </div>
            </section>

            <!-- ASK THE LARK VIEW -->
            <section id="askView" class="view">
                <!-- Results area (above input) -->
                <div class="results-container" id="askResults"></div>

                <div class="ask-container">
                    <!-- First visit intro (hidden for return visitors) -->
                    <div class="ask-intro" id="askIntro">
                        <p class="ask-intro-text">I know the places that change you. The rooms that hum with something. Tell me what you're after ‚Äî or let me draw for you.</p>
                    </div>

                    <!-- Greeting line (different for first/return visits) -->
                    <p class="ask-prompt" id="askPrompt">What kind of night are you after?</p>

                    <div class="ask-input-area">
                        <textarea
                            id="userInput"
                            placeholder="somewhere witchy and weird..."
                            rows="3"
                        ></textarea>
                        <button id="askButton" onclick="askLark()">Whisper to the Lark</button>
                    </div>

                    <!-- Fallback options -->
                    <div class="ask-fallback">
                        <span class="fallback-label">or if you'd rather...</span>
                        <div class="fallback-links">
                            <a href="#" onclick="choosePath('draw'); return false;" class="fallback-link">‚ú¶ Draw a card</a>
                            <a href="#" onclick="choosePath('browse'); return false;" class="fallback-link">‚ò∞ Browse the deck</a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- BROWSE THE DECK VIEW -->
            <section id="browseView" class="view">
                <div class="browse-container">
                    <p class="browse-prompt">The Full Deck</p>
                    <p class="browse-subtext">23 paths through London's soul. Choose your arcana.</p>
                    
                    <!-- Arcana Grid -->
                    <div class="arcana-grid" id="arcanaGrid">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <div class="browse-actions">
                        <button class="action-btn secondary" onclick="returnToEntrance()">Back</button>
                    </div>
                </div>
            </section>

            <!-- ARCANA VENUES VIEW (after clicking an arcana card) -->
            <section id="arcanaVenuesView" class="view">
                <div class="arcana-venues-container">
                    <div class="arcana-venues-header" id="arcanaVenuesHeader">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <div class="arcana-venues-list" id="arcanaVenuesList">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <div class="arcana-venues-actions">
                        <button class="action-btn" onclick="drawFromArcana()">Draw from this Arcana</button>
                        <button class="action-btn secondary" onclick="showView('browse')">Back to Deck</button>
                    </div>
                </div>
            </section>

            <!-- CRISIS RESPONSE VIEW -->
            <section id="crisisView" class="view">
                <div class="crisis-container" id="crisisContent">
                    <!-- Populated dynamically -->
                </div>
                <div class="crisis-actions">
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back</button>
                </div>
            </section>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="feather-loader">ü™∂</div>
        <p class="loading-text">The Lark is listening...</p>
    </div>

    <footer class="main-footer">
        <a href="/about" class="footer-link">About the Lark</a>
        <span class="footer-separator"> ¬∑ </span>
        <a href="/resources" class="footer-link">If you need support</a>
    </footer>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentView = 'ask';
        let currentCardData = null;
        let currentArcana = null;
        let placeholderInterval = null;

        // Time-aware greetings for return visitors
        const timeGreetings = {
            morning: ["The morning light found you here again.", "Back before noon ‚Äî I like your style.", "Early bird, seeking worms of wonder."],
            afternoon: ["The afternoon brought you back.", "Midday wanderer, what calls to you?", "The city hums. So do you."],
            evening: ["The evening stirs something, doesn't it?", "Night approaches. Where shall we send you?", "The gloaming hour ‚Äî my favourite."],
            latenight: ["The late hours have their own magic.", "Still awake? So am I.", "The city's second life is beginning."]
        };

        // Cycling placeholders for search box
        const askPlaceholders = [
            "somewhere witchy and weird...",
            "I want to feel alive tonight...",
            "cosy, with candles and wine...",
            "I don't know ‚Äî surprise me..."
        ];

        // Arcana mapping for display (with symbols!)
        const arcanaMap = {
            'Playful & Weird': { number: '0', name: 'THE FOOL', symbol: '‚óå' },
            'Curious Encounters': { number: 'I', name: 'THE MAGICIAN', symbol: '‚òø' },
            'Witchy & Wild': { number: 'II', name: 'THE HIGH PRIESTESS', symbol: 'ìÇÄ' },
            'Folk & Intimate': { number: 'III', name: 'THE EMPRESS', symbol: '‚öò' },
            'The Thoughtful Stage': { number: 'IV', name: 'THE EMPEROR', symbol: '‚óÜ' },
            'Spiritual / Sacred / Mystical': { number: 'V', name: 'THE HIEROPHANT', symbol: '‚ö∑' },
            'Cabaret & Glitter': { number: 'VI', name: 'THE LOVERS', symbol: '‚öØ' },
            'Big Night Out': { number: 'VII', name: 'THE CHARIOT', symbol: '‚Üë' },
            'Punchy / Protest': { number: 'VIII', name: 'STRENGTH', symbol: '‚àû' },
            'Contemplative & Meditative': { number: 'IX', name: 'THE HERMIT', symbol: '‚ü°' },
            'Global Rhythms': { number: 'X', name: 'WHEEL OF FORTUNE', symbol: '‚óé' },
            'Rant & Rapture': { number: 'XI', name: 'JUSTICE', symbol: '‚öñ' },
            'Body-Based / Movement-Led': { number: 'XII', name: 'THE HANGED MAN', symbol: '‚à¥' },
            'Grief & Grace': { number: 'XIII', name: 'DEATH', symbol: '‚úø' },
            'Word & Voice': { number: 'XIV', name: 'TEMPERANCE', symbol: '‚âã' },
            'Late-Night Lark': { number: 'XV', name: 'THE DEVIL', symbol: '‚õß' },
            'Melancholic Beauty': { number: 'XVI', name: 'THE TOWER', symbol: '‚ÜØ' },
            'Wonder & Awe': { number: 'XVII', name: 'THE STAR', symbol: '‚ú¶' },
            'Nostalgic / Vintage / Retro': { number: 'XVIII', name: 'THE MOON', symbol: '‚òæ' },
            'Comic Relief': { number: 'XIX', name: 'THE SUN', symbol: '‚òÄ' },
            'Group Energy': { number: 'XX', name: 'JUDGEMENT', symbol: '‚ñ≥' },
            'Queer Revelry': { number: 'XXI', name: 'THE WORLD', symbol: '‚óâ' },
            'Romanticised London': { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' }
        };

        // Arcana whispers (taglines for each card)
        const arcanaWhispers = {
            'Playful & Weird': "Fall sideways into something strange",
            'Curious Encounters': "Everything you need is already here",
            'Witchy & Wild': "The moon knows. The woods know.",
            'Folk & Intimate': "Warm strings and stories like home",
            'The Thoughtful Stage': "Theatre that makes you lean in",
            'Spiritual / Sacred / Mystical': "Where the veil thins and reverence rises",
            'Cabaret & Glitter': "Feathers, fire, wit and want",
            'Big Night Out': "The night is a vehicle and you're at the wheel",
            'Punchy / Protest': "Voices raised, truth revealed",
            'Contemplative & Meditative': "Slow, still, deeply felt",
            'Global Rhythms': "Borders blur and culture sings",
            'Rant & Rapture': "Electrifying expression, righteous fire",
            'Body-Based / Movement-Led': "When words aren't enough",
            'Grief & Grace': "For when you need to feel the ache",
            'Word & Voice': "Language that shimmers",
            'Late-Night Lark': "The city stays up with you",
            'Melancholic Beauty': "Beauty that breaks your heart",
            'Wonder & Awe': "Feel small and lit from within",
            'Nostalgic / Vintage / Retro': "A portal to another era",
            'Comic Relief': "The belly-laugh you didn't know you needed",
            'Group Energy': "The crowd becoming one",
            'Queer Revelry': "Sequins, sweat, and chosen family",
            'Romanticised London': "London as you imagined it in books"
        };

        // ============================================
        // VIEW MANAGEMENT
        // ============================================
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Show requested view
            const view = document.getElementById(viewName + 'View');
            if (view) {
                view.classList.add('active');
                currentView = viewName;
            }
        }

        function returnToEntrance() {
            // Return to Ask view (conversation-first default)
            showView('ask');
            setupAskView();
            // Reset draw card state
            document.getElementById('drawnCard').style.display = 'flex';
            document.getElementById('revealedCard').style.display = 'none';
            document.getElementById('drawActions').style.display = 'none';
            // Clear ask results
            document.getElementById('askResults').innerHTML = '';
            document.getElementById('userInput').value = '';
        }

        // ============================================
        // PATH SELECTION
        // ============================================
        function choosePath(path) {
            switch(path) {
                case 'draw':
                    markAsVisited();
                    showView('draw');
                    // Reset card to face-down
                    document.getElementById('drawnCard').style.display = 'flex';
                    document.getElementById('revealedCard').style.display = 'none';
                    document.getElementById('drawActions').style.display = 'none';
                    stopPlaceholderCycle();
                    break;
                case 'ask':
                    showView('ask');
                    setupAskView();
                    document.getElementById('userInput').focus();
                    break;
                case 'browse':
                    markAsVisited();
                    showView('browse');
                    loadFullDeck();
                    stopPlaceholderCycle();
                    break;
            }
        }

        // ============================================
        // ASK VIEW SETUP - First/Return Visit Logic
        // ============================================
        function setupAskView() {
            const isFirstVisit = !localStorage.getItem('lark_visited');
            const introEl = document.getElementById('askIntro');
            const promptEl = document.getElementById('askPrompt');

            if (isFirstVisit) {
                // First visit: show intro, standard question
                introEl.style.display = 'block';
                promptEl.textContent = 'What kind of night are you after?';
                // Note: lark_visited is set when user takes action (search/draw/browse)
            } else {
                // Return visit: hide intro, time-aware greeting
                introEl.style.display = 'none';
                promptEl.textContent = getTimeGreeting() + ' What is it tonight?';
            }

            // Start cycling placeholders
            startPlaceholderCycle();
        }

        function markAsVisited() {
            localStorage.setItem('lark_visited', 'true');
        }

        function getTimeGreeting() {
            const hour = new Date().getHours();
            let period;
            if (hour >= 5 && hour < 12) period = 'morning';
            else if (hour >= 12 && hour < 17) period = 'afternoon';
            else if (hour >= 17 && hour < 22) period = 'evening';
            else period = 'latenight';

            const greetings = timeGreetings[period];
            return greetings[Math.floor(Math.random() * greetings.length)];
        }

        function startPlaceholderCycle() {
            const input = document.getElementById('userInput');
            let index = 0;

            // Set initial placeholder
            input.placeholder = askPlaceholders[index];

            // Clear any existing interval
            stopPlaceholderCycle();

            // Cycle through placeholders every 3.5 seconds
            placeholderInterval = setInterval(() => {
                // Only cycle if input is empty and focused or not focused
                if (input.value === '') {
                    input.classList.add('placeholder-fade');
                    setTimeout(() => {
                        index = (index + 1) % askPlaceholders.length;
                        input.placeholder = askPlaceholders[index];
                        input.classList.remove('placeholder-fade');
                    }, 300);
                }
            }, 3500);
        }

        function stopPlaceholderCycle() {
            if (placeholderInterval) {
                clearInterval(placeholderInterval);
                placeholderInterval = null;
            }
        }

        // ============================================
        // BROWSE THE DECK - FULL DECK VIEW
        // ============================================
        async function loadFullDeck() {
            const grid = document.getElementById('arcanaGrid');
            
            // Show loading state
            grid.innerHTML = '<p class="loading-deck">Shuffling the deck...</p>';
            
            try {
                const response = await fetch('/arcana');
                const data = await response.json();
                
                if (data.error) {
                    grid.innerHTML = '<p class="error-state">The deck scattered... try again?</p>';
                    return;
                }
                
                // Clear and populate grid
                grid.innerHTML = '';
                
                // Sort by arcana order (0, I, II, III, etc.)
                const arcanaOrder = [
                    'Playful & Weird', 'Curious Encounters', 'Witchy & Wild', 'Folk & Intimate',
                    'The Thoughtful Stage', 'Spiritual / Sacred / Mystical', 'Cabaret & Glitter',
                    'Big Night Out', 'Punchy / Protest', 'Contemplative & Meditative', 'Global Rhythms',
                    'Rant & Rapture', 'Body-Based / Movement-Led', 'Grief & Grace', 'Word & Voice',
                    'Late-Night Lark', 'Melancholic Beauty', 'Wonder & Awe', 'Nostalgic / Vintage / Retro',
                    'Comic Relief', 'Group Energy', 'Queer Revelry', 'Romanticised London'
                ];
                
                arcanaOrder.forEach((mood, index) => {
                    const arcanaData = data.arcana.find(a => a.mood === mood);
                    if (arcanaData) {
                        const card = createArcanaCard(arcanaData, index);
                        grid.appendChild(card);
                    }
                });
                
            } catch (error) {
                grid.innerHTML = `<p class="error-state">Something went awry: ${error.message}</p>`;
            }
        }

        function createArcanaCard(arcanaData, index) {
            const arcana = arcanaMap[arcanaData.mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
            const whisper = arcanaWhispers[arcanaData.mood] || '';
            const arcanaKey = getArcanaKey(arcanaData.mood);
            
            const card = document.createElement('div');
            card.className = 'arcana-card card-sm';
            card.setAttribute('data-arcana', arcanaKey);
            card.onclick = () => showArcanaVenues(arcanaData.mood);
            
            // Staggered animation
            card.style.animationDelay = `${index * 50}ms`;
            
            card.innerHTML = `
                <span class="corner-tr"></span>
                <span class="corner-bl"></span>
                <div class="card-inner">
                    <div class="arcana-symbol">${arcana.symbol}</div>
                    <div class="arcana-number">${arcana.number}</div>
                    <div class="arcana-name">${arcana.name}</div>
                    <div class="arcana-mood">${arcanaData.mood}</div>
                    <div class="arcana-count">${arcanaData.venue_count} venues</div>
                </div>
            `;
            
            return card;
        }

        // ============================================
        // ARCANA VENUES VIEW
        // ============================================
        async function showArcanaVenues(mood) {
            currentArcana = mood;
            const arcana = arcanaMap[mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
            const whisper = arcanaWhispers[mood] || '';
            const arcanaKey = getArcanaKey(mood);

            // Update header
            const header = document.getElementById('arcanaVenuesHeader');
            header.innerHTML = `
                <div class="arcana-card card-lg" data-arcana="${arcanaKey}">
                    <span class="corner-tr"></span>
                    <span class="corner-bl"></span>
                    <div class="card-inner">
                        <div class="arcana-symbol">${arcana.symbol}</div>
                        <div class="arcana-number">${arcana.number}</div>
                        <div class="arcana-name">${arcana.name}</div>
                        <div class="arcana-mood">${mood}</div>
                        <div class="arcana-whisper">"${whisper}"</div>
                    </div>
                </div>
            `;

            // Load venues for this arcana
            const venuesList = document.getElementById('arcanaVenuesList');
            venuesList.innerHTML = '<p class="loading-venues">Gathering venues...</p>';

            showView('arcanaVenues');

            try {
                const response = await fetch(`/arcana/${encodeURIComponent(mood)}`);
                const data = await response.json();

                if (data.error) {
                    venuesList.innerHTML = '<p class="error-state">Could not find venues...</p>';
                    return;
                }

                venuesList.innerHTML = '';

                data.venues.forEach((venue, index) => {
                    const card = document.createElement('div');
                    card.className = 'arcana-card card-sm venue-browse-card';
                    card.setAttribute('data-arcana', arcanaKey);
                    card.style.animationDelay = `${index * 50}ms`;

                    let venueLink = venue.name;
                    if (venue.website && venue.website.trim() && !venue.website.startsWith('(')) {
                        let url = venue.website;
                        if (!url.startsWith('http')) url = 'https://' + url;
                        venueLink = `<a href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${venue.name}</a>`;
                    }

                    const venueWhisper = venue.whisper || '';
                    const venueBlurb = venue.blurb || venue.whisper || '';

                    card.innerHTML = `
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-inner">
                            <div class="venue-name">${venueLink}</div>
                            <div class="venue-location">${venue.area || 'London'}</div>
                            <div class="venue-whisper">${venueWhisper}</div>
                            <div class="venue-blurb" style="display: none;">${venueBlurb}</div>
                        </div>
                    `;

                    // Click to expand/collapse
                    card.onclick = (e) => {
                        if (e.target.tagName === 'A') return;
                        toggleCardExpansion(card);
                    };

                    venuesList.appendChild(card);
                });

            } catch (error) {
                venuesList.innerHTML = `<p class="error-state">Something went awry: ${error.message}</p>`;
            }
        }

        function drawFromArcana() {
            if (!currentArcana) return;

            showView('draw');
            document.getElementById('drawnCard').style.display = 'flex';
            document.getElementById('revealedCard').style.display = 'none';
            document.getElementById('drawActions').style.display = 'none';
            // Face-down card shown ‚Äî user taps to reveal (currentArcana is preserved)
        }

        // ============================================
        // DRAW A CARD
        // ============================================
        async function revealCard(filteredArcana = null) {
            const drawnCard = document.getElementById('drawnCard');
            const revealedCard = document.getElementById('revealedCard');
            const drawActions = document.getElementById('drawActions');
            
            // If already revealed, do nothing
            if (drawnCard.style.display === 'none') return;
            
            // Show loading
            showLoading();
            
            try {
                const body = filteredArcana ? { arcana: filteredArcana } : {};
                
                const response = await fetch('/surprise', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Store card data
                currentCardData = data;
                
                // Get arcana info
                const arcana = arcanaMap[data.mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
                
                // Populate revealed card
                document.getElementById('cardArcanaSymbol').textContent = arcana.symbol;
                document.getElementById('cardArcanaNumber').textContent = arcana.number;
                document.getElementById('cardArcanaName').textContent = arcana.name;
                document.getElementById('cardArcanaMood').textContent = data.mood || 'A London Mystery';
                
                // Venue details
                const venueName = document.getElementById('cardVenueName');
                if (data.website && data.website.trim() && !data.website.startsWith('(')) {
                    let url = data.website;
                    if (!url.startsWith('http')) url = 'https://' + url;
                    venueName.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${data.venue_name}</a>`;
                } else {
                    venueName.textContent = data.venue_name;
                }
                
                document.getElementById('cardVenueLocation').textContent = data.area || 'London';
                document.getElementById('cardVenueBlurb').textContent = data.response || '';
                
                // Set arcana glow
                revealedCard.setAttribute('data-arcana', getArcanaKey(data.mood));
                
                // Animate the reveal
                drawnCard.style.display = 'none';
                revealedCard.style.display = 'block';
                revealedCard.classList.add('card-reveal');
                
                // Show actions
                setTimeout(() => {
                    drawActions.style.display = 'flex';
                }, 500);
                
            } catch (error) {
                hideLoading();
                alert('Something went awry: ' + error.message);
            }
        }

        function drawAnother() {
            const drawnCard = document.getElementById('drawnCard');
            const revealedCard = document.getElementById('revealedCard');
            const drawActions = document.getElementById('drawActions');
            
            // Reset
            revealedCard.style.display = 'none';
            revealedCard.classList.remove('card-reveal');
            drawActions.style.display = 'none';
            drawnCard.style.display = 'flex';
            
            // Clear filtered arcana
            currentArcana = null;
        }

        function getArcanaKey(mood) {
            const keyMap = {
                'Playful & Weird': 'fool',
                'Curious Encounters': 'magician',
                'Witchy & Wild': 'priestess',
                'Folk & Intimate': 'empress',
                'The Thoughtful Stage': 'emperor',
                'Spiritual / Sacred / Mystical': 'hierophant',
                'Cabaret & Glitter': 'lovers',
                'Big Night Out': 'chariot',
                'Punchy / Protest': 'strength',
                'Contemplative & Meditative': 'hermit',
                'Global Rhythms': 'wheel',
                'Rant & Rapture': 'justice',
                'Body-Based / Movement-Led': 'hanged',
                'Grief & Grace': 'death',
                'Word & Voice': 'temperance',
                'Late-Night Lark': 'devil',
                'Melancholic Beauty': 'tower',
                'Wonder & Awe': 'star',
                'Nostalgic / Vintage / Retro': 'moon',
                'Comic Relief': 'sun',
                'Group Energy': 'judgement',
                'Queer Revelry': 'world',
                'Romanticised London': 'lark'
            };
            return keyMap[mood] || 'lark';
        }

        // ============================================
        // ASK THE LARK
        // ============================================
        async function askLark() {
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            const resultsContainer = document.getElementById('askResults');

            if (!prompt) return;

            // Mark as visited on first search
            markAsVisited();

            // Disable input
            input.disabled = true;
            document.getElementById('askButton').disabled = true;

            showLoading();
            
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                const data = await response.json();
                hideLoading();
                
                // Clear previous results
                resultsContainer.innerHTML = '';
                
                // =====================================================
                // SAFETY TIER HANDLING
                // =====================================================
                
                // Handle crisis tier - show resources FIRST
                if (data.safety && data.safety.show_crisis_resources) {
                    const crisisBox = document.createElement('div');
                    crisisBox.className = 'safety-crisis-box';
                    crisisBox.innerHTML = `
                        <div class="crisis-header">
                            <span class="crisis-icon">üïäÔ∏è</span>
                            <span class="crisis-title">YOU MATTER</span>
                        </div>
                        <p class="lark-says">${data.safety.lark_preamble || "I hear you, petal. Before anything else ‚Äî there are people who want to help hold what you're carrying right now."}</p>
                        <div class="crisis-contacts">
                            <div class="crisis-contact">
                                <span class="contact-icon">üìû</span>
                                <div class="contact-info">
                                    <span class="contact-name">Samaritans</span>
                                    <span class="contact-number"><a href="tel:116123">116 123</a></span>
                                    <span class="contact-note">Free, 24/7, no judgment</span>
                                </div>
                            </div>
                            <div class="crisis-contact">
                                <span class="contact-icon">üí¨</span>
                                <div class="contact-info">
                                    <span class="contact-name">Crisis Text Line</span>
                                    <span class="contact-number">Text <a href="sms:85258">SHOUT to 85258</a></span>
                                    <span class="contact-note">Free, 24/7, text-based</span>
                                </div>
                            </div>
                            <div class="crisis-contact">
                                <span class="contact-icon">üè•</span>
                                <div class="contact-info">
                                    <span class="contact-name">NHS Mental Health</span>
                                    <span class="contact-number"><a href="tel:111">111</a> (press 2)</span>
                                    <span class="contact-note">24/7 urgent support</span>
                                </div>
                            </div>
                        </div>
                        <p class="venue-offer">If you'd still like somewhere gentle to go, I can offer that too...</p>
                    `;
                    resultsContainer.appendChild(crisisBox);
                }
                
                // Handle distress tier - show support box above venues
                if (data.safety && data.safety.show_support_box) {
                    const supportBox = document.createElement('div');
                    supportBox.className = 'safety-support-box';
                    supportBox.innerHTML = `
                        <p class="lark-says">${data.safety.lark_preamble || "That sounds really hard. I'm here ‚Äî and so are others, if you need them."}</p>
                        <div class="support-links">
                            <a href="tel:116123" class="support-link"><span class="icon">üìû</span> Samaritans: 116 123</a>
                            <a href="sms:85258" class="support-link"><span class="icon">üí¨</span> Text SHOUT to 85258</a>
                            <a href="/resources" class="more-link">more support ‚Üí</a>
                        </div>
                    `;
                    resultsContainer.appendChild(supportBox);
                }
                
                // =====================================================
                // VENUE RENDERING
                // =====================================================
                if (data.responses && data.responses.length > 0) {
                    // Show Lark's intro text if present
                    if (data.intro) {
                        const intro = document.createElement('p');
                        intro.className = 'lark-intro';
                        intro.textContent = data.intro;
                        resultsContainer.appendChild(intro);
                    }
                    
                    // Render venue cards with staggered animation
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            const card = createVenueCard(resp, data.mood);
                            resultsContainer.appendChild(card);
                            
                            // After all venues, add soft footer if needed (Tier 2)
                            if (index === data.responses.length - 1) {
                                if (data.safety && data.safety.show_soft_footer) {
                                    const softFooter = document.createElement('div');
                                    softFooter.className = 'safety-soft-footer';
                                    softFooter.innerHTML = `
                                        If you need more than a venue tonight, <a href="/resources">others are here too</a>.
                                    `;
                                    resultsContainer.appendChild(softFooter);
                                }
                            }
                        }, index * 200);
                    });
                    
                } else {
                    // Empty state - no venues found
                    resultsContainer.innerHTML += `
                        <div class="empty-state">
                            <p>The wind found no doors tonight, petal.</p>
                            <p class="empty-subtext">Try another path, or speak differently.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                hideLoading();
                resultsContainer.innerHTML = `<div class="error-state">Something went awry: ${error.message}</div>`;
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('askButton').disabled = false;
            input.value = '';
            input.focus();
        }

        function createVenueCard(venue, mood) {
            const card = document.createElement('div');
            const arcana = arcanaMap[mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
            const arcanaKey = getArcanaKey(mood);
            const whisper = venue.whisper || arcanaWhispers[mood] || '';

            card.className = 'arcana-card card-sm venue-card-result';
            card.setAttribute('data-arcana', arcanaKey);

            // Store venue data for expansion
            card.dataset.venueBlurb = venue.text || '';
            card.dataset.venueWebsite = venue.website || '';

            let venueLink = venue.venue_name;
            if (venue.website && venue.website.trim() && !venue.website.startsWith('(')) {
                let url = venue.website;
                if (!url.startsWith('http')) url = 'https://' + url;
                venueLink = `<a href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${venue.venue_name}</a>`;
            }

            card.innerHTML = `
                <span class="corner-tr"></span>
                <span class="corner-bl"></span>
                <div class="card-inner">
                    <div class="arcana-symbol">${arcana.symbol}</div>
                    <div class="arcana-number">${arcana.number}</div>
                    <div class="arcana-name">${arcana.name}</div>
                    <div class="arcana-mood">${mood}</div>
                    <div class="arcana-divider"></div>
                    <div class="venue-section">
                        <div class="venue-name">${venueLink}</div>
                        <div class="venue-whisper">${whisper}</div>
                        <div class="venue-blurb" style="display: none;">${venue.text || ''}</div>
                    </div>
                </div>
            `;

            // Click to expand/collapse
            card.onclick = (e) => {
                if (e.target.tagName === 'A') return; // Don't toggle if clicking link
                toggleCardExpansion(card);
            };

            return card;
        }

        function toggleCardExpansion(card) {
            const isExpanded = card.classList.contains('card-lg');
            const whisperEl = card.querySelector('.venue-whisper');
            const blurbEl = card.querySelector('.venue-blurb');

            if (isExpanded) {
                // Collapse
                card.classList.remove('card-lg');
                card.classList.add('card-sm');
                if (whisperEl) whisperEl.style.display = 'block';
                if (blurbEl) blurbEl.style.display = 'none';
            } else {
                // Expand
                card.classList.remove('card-sm');
                card.classList.add('card-lg');
                if (whisperEl) whisperEl.style.display = 'none';
                if (blurbEl) blurbEl.style.display = 'block';
            }
        }

        // ============================================
        // CRISIS HANDLING (legacy - kept for compatibility)
        // ============================================
        function renderCrisisResponse(crisisData) {
            const container = document.getElementById('crisisContent');
            container.innerHTML = `
                <div class="crisis-message">
                    <p class="crisis-intro">${crisisData.intro || "I hear something in your words that makes me want to reach beyond venues tonight."}</p>
                    <div class="crisis-resources">
                        <p class="resources-label">These humans know how to hold what you're carrying:</p>
                        <ul class="resources-list">
                            <li><strong>Samaritans:</strong> 116 123 (free, 24/7)</li>
                            <li><strong>Crisis Text Line:</strong> Text SHOUT to 85258</li>
                            <li><strong>NHS Urgent:</strong> 111, option 2</li>
                        </ul>
                    </div>
                    <p class="crisis-closing">${crisisData.closing || "I'm here, but I'm not enough for all pain. Let others help carry this."}</p>
                </div>
            `;
            showView('crisis');
        }

        function renderDistressResponse(data) {
            const resultsContainer = document.getElementById('askResults');
            
            // Show resources first
            const resourcesDiv = document.createElement('div');
            resourcesDiv.className = 'distress-resources';
            resourcesDiv.innerHTML = `
                <p class="distress-intro">${data.crisis_response.intro || "I sense heaviness in your words."}</p>
                <div class="resources-compact">
                    <span>Samaritans: 116 123</span> ¬∑ <span>Text SHOUT to 85258</span>
                </div>
            `;
            resultsContainer.appendChild(resourcesDiv);
            
            // Then show venues if present
            if (data.responses && data.responses.length > 0) {
                const venueIntro = document.createElement('p');
                venueIntro.className = 'venue-intro-after-resources';
                venueIntro.textContent = data.crisis_response.venue_intro || "And if you still want a place to sit with this feeling:";
                resultsContainer.appendChild(venueIntro);
                
                data.responses.forEach((resp, index) => {
                    setTimeout(() => {
                        const card = createVenueCard(resp, data.mood);
                        resultsContainer.appendChild(card);
                    }, index * 200);
                });
            }
        }

        // ============================================
        // LOADING
        // ============================================
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Enter to submit in ask view
            if (e.key === 'Enter' && !e.shiftKey && currentView === 'ask') {
                const input = document.getElementById('userInput');
                if (document.activeElement === input) {
                    e.preventDefault();
                    askLark();
                }
            }
            
            // Escape to go back
            if (e.key === 'Escape' && currentView !== 'ask') {
                if (currentView === 'arcanaVenues') {
                    showView('browse');
                } else {
                    returnToEntrance();
                }
            }
        });

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Conversation-first: Ask view is the default landing
            showView('ask');
            setupAskView();
        });
    </script>
</body>
</html>
