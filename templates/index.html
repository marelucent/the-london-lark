<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The London Lark</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        
        <!-- HEADER - The Lark's Mark -->
        <header>
            <h1 onclick="returnToEntrance()" style="cursor: pointer;">‚ú¶ THE LONDON LARK ‚ú¶</h1>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="mainContent">
            
            <!-- ENTRANCE: Portal Moment -->
            <section id="entranceView" class="view active">
                <div class="portal-moment">
                    <p class="opening-line" id="openingLine">{{ greeting }}</p>
                    <p class="portal-question">How would you like to begin?</p>
                </div>
                
                <!-- The Three Paths -->
                <div class="paths-container">
                    <div class="path-card" onclick="choosePath('draw')">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="path-icon">üÉè</div>
                        <div class="path-title">DRAW A CARD</div>
                        <div class="path-whisper">"Let fate decide"</div>
                    </div>
                    
                    <div class="path-card" onclick="choosePath('ask')">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="path-icon">üí¨</div>
                        <div class="path-title">ASK THE LARK</div>
                        <div class="path-whisper">"Tell me what you seek"</div>
                    </div>
                    
                    <div class="path-card" onclick="choosePath('browse')">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="path-icon">üé¥</div>
                        <div class="path-title">BROWSE THE DECK</div>
                        <div class="path-whisper">"Lay out the cards"</div>
                    </div>
                </div>
            </section>

            <!-- DRAW A CARD VIEW -->
            <section id="drawView" class="view">
                <div class="draw-container">
                    <!-- Face-down card -->
                    <div class="arcana-card card-lg face-down" id="drawnCard" onclick="revealCard()">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-back-symbol">‚ú¶</div>
                        <div class="card-back-prompt">tap when you're ready</div>
                    </div>
                    
                    <!-- Revealed card (hidden initially) -->
                    <div class="arcana-card card-lg" id="revealedCard" style="display: none;">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-inner">
                            <div class="arcana-number" id="cardArcanaNumber"></div>
                            <div class="arcana-name" id="cardArcanaName"></div>
                            <div class="arcana-mood" id="cardArcanaMood"></div>
                            <div class="arcana-divider"></div>
                            <div class="venue-section">
                                <div class="venue-name" id="cardVenueName"></div>
                                <div class="venue-location" id="cardVenueLocation"></div>
                                <div class="venue-blurb" id="cardVenueBlurb"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Draw actions -->
                <div class="draw-actions" id="drawActions" style="display: none;">
                    <button class="action-btn" onclick="drawAnother()">Draw Another</button>
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back to Paths</button>
                </div>
            </section>

            <!-- ASK THE LARK VIEW -->
            <section id="askView" class="view">
                <div class="ask-container">
                    <p class="ask-prompt">Speak freely. She's listening.</p>
                    
                    <div class="ask-input-area">
                        <textarea
                            id="userInput"
                            placeholder="I want to feel alive tonight..."
                            rows="3"
                        ></textarea>
                        <button id="askButton" onclick="askLark()">Whisper to the Lark</button>
                    </div>
                </div>
                
                <!-- Results area -->
                <div class="results-container" id="askResults"></div>
                
                <div class="ask-actions">
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back to Paths</button>
                </div>
            </section>

            <!-- BROWSE THE DECK VIEW -->
            <section id="browseView" class="view">
                <div class="browse-container">
                    <p class="browse-prompt">The deck awaits...</p>
                    <p class="browse-subtext">Full browsing coming soon. For now, try drawing a card or asking the Lark.</p>
                    
                    <div class="browse-actions">
                        <button class="action-btn secondary" onclick="returnToEntrance()">Back to Paths</button>
                    </div>
                </div>
            </section>

            <!-- CRISIS RESPONSE VIEW -->
            <section id="crisisView" class="view">
                <div class="crisis-container" id="crisisContent">
                    <!-- Populated dynamically -->
                </div>
                <div class="crisis-actions">
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back to Paths</button>
                </div>
            </section>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="feather-loader">ü™∂</div>
        <p class="loading-text">The Lark is listening...</p>
    </div>

    <footer class="main-footer">
        <a href="/about" class="footer-link">About the Lark</a>
        <span class="footer-separator"> ¬∑ </span>
        <a href="/resources" class="footer-link">If you need support</a>
    </footer>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentView = 'entrance';
        let currentCardData = null;

        // Arcana mapping for display
        const arcanaMap = {
            'Playful & Weird': { number: '0', name: 'THE FOOL' },
            'Curious Encounters': { number: 'I', name: 'THE MAGICIAN' },
            'Witchy & Wild': { number: 'II', name: 'THE HIGH PRIESTESS' },
            'Folk & Intimate': { number: 'III', name: 'THE EMPRESS' },
            'The Thoughtful Stage': { number: 'IV', name: 'THE EMPEROR' },
            'Spiritual / Sacred / Mystical': { number: 'V', name: 'THE HIEROPHANT' },
            'Cabaret & Glitter': { number: 'VI', name: 'THE LOVERS' },
            'Big Night Out': { number: 'VII', name: 'THE CHARIOT' },
            'Punchy / Protest': { number: 'VIII', name: 'STRENGTH' },
            'Contemplative & Meditative': { number: 'IX', name: 'THE HERMIT' },
            'Global Rhythms': { number: 'X', name: 'WHEEL OF FORTUNE' },
            'Rant & Rapture': { number: 'XI', name: 'JUSTICE' },
            'Body-Based / Movement-Led': { number: 'XII', name: 'THE HANGED MAN' },
            'Grief & Grace': { number: 'XIII', name: 'DEATH' },
            'Word & Voice': { number: 'XIV', name: 'TEMPERANCE' },
            'Late-Night Lark': { number: 'XV', name: 'THE DEVIL' },
            'Melancholic Beauty': { number: 'XVI', name: 'THE TOWER' },
            'Wonder & Awe': { number: 'XVII', name: 'THE STAR' },
            'Nostalgic / Vintage / Retro': { number: 'XVIII', name: 'THE MOON' },
            'Comic Relief': { number: 'XIX', name: 'THE SUN' },
            'Group Energy': { number: 'XX', name: 'JUDGEMENT' },
            'Queer Revelry': { number: 'XXI', name: 'THE WORLD' },
            'Romanticised London': { number: '‚ú¶', name: 'THE LARK' }
        };

        // ============================================
        // VIEW MANAGEMENT
        // ============================================
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Show requested view
            const view = document.getElementById(viewName + 'View');
            if (view) {
                view.classList.add('active');
                currentView = viewName;
            }
        }

        function returnToEntrance() {
            showView('entrance');
            // Reset draw card state
            document.getElementById('drawnCard').style.display = 'flex';
            document.getElementById('revealedCard').style.display = 'none';
            document.getElementById('drawActions').style.display = 'none';
            // Clear ask results
            document.getElementById('askResults').innerHTML = '';
            document.getElementById('userInput').value = '';
        }

        // ============================================
        // PATH SELECTION
        // ============================================
        function choosePath(path) {
            switch(path) {
                case 'draw':
                    showView('draw');
                    // Reset card to face-down
                    document.getElementById('drawnCard').style.display = 'flex';
                    document.getElementById('revealedCard').style.display = 'none';
                    document.getElementById('drawActions').style.display = 'none';
                    break;
                case 'ask':
                    showView('ask');
                    document.getElementById('userInput').focus();
                    break;
                case 'browse':
                    showView('browse');
                    break;
            }
        }

        // ============================================
        // DRAW A CARD
        // ============================================
        async function revealCard() {
            const drawnCard = document.getElementById('drawnCard');
            const revealedCard = document.getElementById('revealedCard');
            const drawActions = document.getElementById('drawActions');
            
            // If already revealed, do nothing
            if (drawnCard.style.display === 'none') return;
            
            // Show loading
            showLoading();
            
            try {
                const response = await fetch('/surprise', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Store card data
                currentCardData = data;
                
                // Get arcana info
                const arcana = arcanaMap[data.mood] || { number: '‚ú¶', name: 'THE LARK' };
                
                // Populate revealed card
                document.getElementById('cardArcanaNumber').textContent = arcana.number;
                document.getElementById('cardArcanaName').textContent = arcana.name;
                document.getElementById('cardArcanaMood').textContent = data.mood || 'A London Mystery';
                
                // Venue details
                const venueName = document.getElementById('cardVenueName');
                if (data.website && data.website.trim() && !data.website.startsWith('(')) {
                    let url = data.website;
                    if (!url.startsWith('http')) url = 'https://' + url;
                    venueName.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${data.venue_name}</a>`;
                } else {
                    venueName.textContent = data.venue_name;
                }
                
                document.getElementById('cardVenueLocation').textContent = data.area || 'London';
                document.getElementById('cardVenueBlurb').textContent = data.response || '';
                
                // Set arcana glow
                const arcanaKey = data.mood?.toLowerCase().replace(/[^a-z]/g, '') || 'lark';
                revealedCard.setAttribute('data-arcana', getArcanaKey(data.mood));
                
                // Animate the reveal
                drawnCard.style.display = 'none';
                revealedCard.style.display = 'block';
                revealedCard.classList.add('card-reveal');
                
                // Show actions
                setTimeout(() => {
                    drawActions.style.display = 'flex';
                }, 500);
                
            } catch (error) {
                hideLoading();
                alert('Something went awry: ' + error.message);
            }
        }

        function drawAnother() {
            const drawnCard = document.getElementById('drawnCard');
            const revealedCard = document.getElementById('revealedCard');
            const drawActions = document.getElementById('drawActions');
            
            // Reset
            revealedCard.style.display = 'none';
            revealedCard.classList.remove('card-reveal');
            drawActions.style.display = 'none';
            drawnCard.style.display = 'flex';
        }

        function getArcanaKey(mood) {
            const keyMap = {
                'Playful & Weird': 'fool',
                'Curious Encounters': 'magician',
                'Witchy & Wild': 'priestess',
                'Folk & Intimate': 'empress',
                'The Thoughtful Stage': 'emperor',
                'Spiritual / Sacred / Mystical': 'hierophant',
                'Cabaret & Glitter': 'lovers',
                'Big Night Out': 'chariot',
                'Punchy / Protest': 'strength',
                'Contemplative & Meditative': 'hermit',
                'Global Rhythms': 'wheel',
                'Rant & Rapture': 'justice',
                'Body-Based / Movement-Led': 'hanged',
                'Grief & Grace': 'death',
                'Word & Voice': 'temperance',
                'Late-Night Lark': 'devil',
                'Melancholic Beauty': 'tower',
                'Wonder & Awe': 'star',
                'Nostalgic / Vintage / Retro': 'moon',
                'Comic Relief': 'sun',
                'Group Energy': 'judgement',
                'Queer Revelry': 'world',
                'Romanticised London': 'lark'
            };
            return keyMap[mood] || 'lark';
        }

        // ============================================
        // ASK THE LARK
        // ============================================
        async function askLark() {
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            const resultsContainer = document.getElementById('askResults');
            
            if (!prompt) return;
            
            // Disable input
            input.disabled = true;
            document.getElementById('askButton').disabled = true;
            
            showLoading();
            
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                const data = await response.json();
                hideLoading();
                
                // Clear previous results
                resultsContainer.innerHTML = '';
                
                // Handle crisis response
                if (data.distress_level === 'crisis' && data.crisis_response) {
                    renderCrisisResponse(data.crisis_response);
                    input.disabled = false;
                    document.getElementById('askButton').disabled = false;
                    return;
                }
                
                // Handle distress with venues
                if (data.distress_level === 'distress' && data.crisis_response) {
                    renderDistressResponse(data);
                    input.disabled = false;
                    document.getElementById('askButton').disabled = false;
                    return;
                }
                
                // Normal response - render as cards
                if (data.responses && data.responses.length > 0) {
                    const arcana = arcanaMap[data.mood] || { number: '‚ú¶', name: 'THE LARK' };
                    
                    // Add a whisper intro
                    const introDiv = document.createElement('div');
                    introDiv.className = 'results-intro';
                    introDiv.innerHTML = `<span class="arcana-badge">${arcana.number} ¬∑ ${arcana.name}</span> <span class="mood-label">${data.mood || ''}</span>`;
                    resultsContainer.appendChild(introDiv);
                    
                    // Render venue cards
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            const card = createVenueCard(resp, data.mood);
                            resultsContainer.appendChild(card);
                        }, index * 200);
                    });
                    
                    // Add melancholy footer if present
                    if (data.distress_level === 'melancholy' && data.melancholy_footer) {
                        setTimeout(() => {
                            const footer = document.createElement('div');
                            footer.className = 'melancholy-footer';
                            footer.innerHTML = data.melancholy_footer.html;
                            resultsContainer.appendChild(footer);
                        }, data.responses.length * 200 + 300);
                    }
                } else {
                    // Empty state
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>The wind found no doors tonight, petal.</p>
                            <p class="empty-subtext">Try another path, or speak differently.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                hideLoading();
                resultsContainer.innerHTML = `<div class="error-state">Something went awry: ${error.message}</div>`;
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('askButton').disabled = false;
            input.value = '';
            input.focus();
        }

        function createVenueCard(venue, mood) {
            const card = document.createElement('div');
            card.className = 'venue-result-card';
            card.setAttribute('data-arcana', getArcanaKey(mood));
            
            let venueLink = venue.venue_name;
            if (venue.website && venue.website.trim() && !venue.website.startsWith('(')) {
                let url = venue.website;
                if (!url.startsWith('http')) url = 'https://' + url;
                venueLink = `<a href="${url}" target="_blank" rel="noopener">${venue.venue_name}</a>`;
            }
            
            card.innerHTML = `
                <div class="venue-result-name">${venueLink}</div>
                <div class="venue-result-location">${venue.area || 'London'}</div>
                <div class="venue-result-blurb">${venue.text}</div>
            `;
            
            return card;
        }

        // ============================================
        // CRISIS HANDLING
        // ============================================
        function renderCrisisResponse(crisisData) {
            const container = document.getElementById('crisisContent');
            container.innerHTML = `
                <div class="crisis-message">
                    <p class="crisis-intro">${crisisData.intro || "I hear something in your words that makes me want to reach beyond venues tonight."}</p>
                    <div class="crisis-resources">
                        <p class="resources-label">These humans know how to hold what you're carrying:</p>
                        <ul class="resources-list">
                            <li><strong>Samaritans:</strong> 116 123 (free, 24/7)</li>
                            <li><strong>Crisis Text Line:</strong> Text SHOUT to 85258</li>
                            <li><strong>NHS Urgent:</strong> 111, option 2</li>
                        </ul>
                    </div>
                    <p class="crisis-closing">${crisisData.closing || "I'm here, but I'm not enough for all pain. Let others help carry this."}</p>
                </div>
            `;
            showView('crisis');
        }

        function renderDistressResponse(data) {
            const resultsContainer = document.getElementById('askResults');
            
            // Show resources first
            const resourcesDiv = document.createElement('div');
            resourcesDiv.className = 'distress-resources';
            resourcesDiv.innerHTML = `
                <p class="distress-intro">${data.crisis_response.intro || "I sense heaviness in your words."}</p>
                <div class="resources-compact">
                    <span>Samaritans: 116 123</span> ¬∑ <span>Text SHOUT to 85258</span>
                </div>
            `;
            resultsContainer.appendChild(resourcesDiv);
            
            // Then show venues if present
            if (data.responses && data.responses.length > 0) {
                const venueIntro = document.createElement('p');
                venueIntro.className = 'venue-intro-after-resources';
                venueIntro.textContent = data.crisis_response.venue_intro || "And if you still want a place to sit with this feeling:";
                resultsContainer.appendChild(venueIntro);
                
                data.responses.forEach((resp, index) => {
                    setTimeout(() => {
                        const card = createVenueCard(resp, data.mood);
                        resultsContainer.appendChild(card);
                    }, index * 200);
                });
            }
        }

        // ============================================
        // LOADING
        // ============================================
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Enter to submit in ask view
            if (e.key === 'Enter' && !e.shiftKey && currentView === 'ask') {
                const input = document.getElementById('userInput');
                if (document.activeElement === input) {
                    e.preventDefault();
                    askLark();
                }
            }
            
            // Escape to go back
            if (e.key === 'Escape' && currentView !== 'entrance') {
                returnToEntrance();
            }
        });

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            showView('entrance');
        });
    </script>
</body>
</html>
