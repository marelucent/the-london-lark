<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The London Lark</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üïäÔ∏è THE LONDON LARK</h1>
            <p class="tagline">A poetic companion for London's cultural undercurrent</p>
        </header>

        <div class="conversation" id="conversation">
            <div class="intro">
                <div class="time-greeting">{{ greeting }}</div>
                {{ helper.main }}<br>
                <small>{{ helper.sub }}</small>
            </div>
        </div>

        <div class="input-area">
            <textarea
                id="userInput"
                placeholder="{{ placeholder }}"
                rows="3"
            ></textarea>
            <div class="button-group">
                <button id="askButton" onclick="askLark()">Ask the Lark</button>
                <button id="surpriseButton" class="surprise-btn" onclick="surpriseMe()">üé≤ Surprise Me</button>
            </div>
        </div>
    </div>

    <!-- Dev Mood Tuner Toggle -->
    <button class="dev-toggle" onclick="toggleMoodTuner()">üîß Mood Tuner</button>

    <!-- Mood Tuner Panel -->
    <div class="mood-tuner" id="moodTuner">
        <button class="close-btn" onclick="toggleMoodTuner()">√ó</button>
        <h3>üé≠ Mood Tuner</h3>

        <div class="parse-result">
            <strong>Last Parse Result:</strong>
            <pre id="parseResult">No query yet...</pre>
        </div>

        <div class="test-moods">
            <strong style="font-size: 0.85rem; color: #b0c4de;">Test Moods:</strong><br>
            <button class="test-mood-btn" onclick="testMood('Folk & Intimate')">Folk & Intimate</button>
            <button class="test-mood-btn" onclick="testMood('Queer Revelry')">Queer Revelry</button>
            <button class="test-mood-btn" onclick="testMood('Melancholic Beauty')">Melancholic Beauty</button>
            <button class="test-mood-btn" onclick="testMood('Late-Night Lark')">Late-Night Lark</button>
            <button class="test-mood-btn" onclick="testMood('Curious Encounters')">Curious Encounters</button>
            <button class="test-mood-btn" onclick="testMood('The Thoughtful Stage')">The Thoughtful Stage</button>
            <button class="test-mood-btn" onclick="testMood('Global Rhythms')">Global Rhythms</button>
            <button class="test-mood-btn" onclick="testMood('Cabaret & Glitter')">Cabaret & Glitter</button>
        </div>

        <div style="margin-top: 1.5rem;">
            <strong style="font-size: 0.85rem; color: #b0c4de;">Current Filters:</strong>
            <pre id="currentFilters" style="background: rgba(0,0,0,0.3); padding: 0.8rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.8rem;">None</pre>
        </div>
    </div>

    <script>
        const conversation = document.getElementById('conversation');
        const userInput = document.getElementById('userInput');
        const askButton = document.getElementById('askButton');
        const parseResult = document.getElementById('parseResult');
        const currentFilters = document.getElementById('currentFilters');

        // Mood to icon mapping
        const moodIcons = {
            'Folk & Intimate': 'üåø',
            'Queer Revelry': 'üåà',
            'Melancholic Beauty': 'üåô',
            'Late-Night Lark': 'ü¶â',
            'Curious Encounters': '‚ú®',
            'The Thoughtful Stage': 'üé≠',
            'Global Rhythms': 'üåç',
            'Cabaret & Glitter': 'üí´',
            'Poetic': 'üìú',
            'Punchy / Protest': 'üî•',
            'Big Night Out': 'üéâ',
            'Comic Relief': 'üòÑ',
            'Dreamlike & Hypnagogic': 'üí≠',
            'Wonder & Awe': 'üåü',
            'Spiritual / Sacred / Mystical': 'üïØÔ∏è',
            'Playful & Weird': 'üé™',
            'Nostalgic / Vintage / Retro': 'üìª',
            'Body-Based / Movement-Led': 'üíÉ',
            'Grief & Grace': 'üïäÔ∏è',
            'Witchy & Wild': 'üåõ'
        };

        // Poetic empty state messages
        const emptyStateMessages = [
            "The wind found no doors tonight, petal. Try another path.",
            "Even the Lark must sometimes rest her wings. No matches found.",
            "The city hums, but not in that key tonight. Seek elsewhere.",
            "No feathers stirred for this request. Perhaps rephrase your longing?",
            "The map is vast, but this corner lies silent. Ask again differently."
        ];

        // Focus input on load
        userInput.focus();

        // Allow Enter to submit (Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askLark();
            }
        });

        function clearIntro() {
            const intro = conversation.querySelector('.intro');
            if (intro) {
                intro.remove();
            }
        }

        function getMoodIcon(mood) {
            return moodIcons[mood] || 'üéµ';
        }

        function addMessage(type, content, details = {}) {
            clearIntro();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            let html = `<div class="message-label">${type === 'user' ? 'You' : 'The Lark'}</div>`;
            html += `<div class="message-text">${content}</div>`;

            if (details.venue_name) {
                const venueName = details.venue_name;
                const area = details.area ? ' in ' + details.area : '';
                const website = details.website;

                // Make venue name clickable if website exists
                if (website && website !== '(n/a ‚Äî pub site or folk club listing)' && website.trim() && !website.startsWith('(')) {
                    let url = website;
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        url = 'https://' + url;
                    }
                    html += `<div class="venue-details">üìç <a href="${url}" target="_blank" rel="noopener noreferrer" class="venue-link">${venueName}</a>${area}</div>`;
                } else {
                    html += `<div class="venue-details">üìç ${venueName}${area}</div>`;
                }
            }

            if (details.mood) {
                const icon = getMoodIcon(details.mood);
                const confidenceText = details.confidence < 1.0 ? ` ¬∑ ${Math.round(details.confidence * 100)}%` : '';
                html += `<div class="mood-badge"><span class="mood-icon">${icon}</span>${details.mood}${confidenceText}</div>`;
            }

            messageDiv.innerHTML = html;
            conversation.appendChild(messageDiv);

            // Scroll to bottom
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        function showLoader() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'currentLoader';
            loadingDiv.innerHTML = `
                <div class="feather-loader">ü™∂</div>
                <div class="loading-text">The Lark is composing...</div>
            `;
            conversation.appendChild(loadingDiv);
            loadingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return loadingDiv;
        }

        function removeLoader() {
            const loader = document.getElementById('currentLoader');
            if (loader) loader.remove();
        }

        function showEmptyState() {
            const message = emptyStateMessages[Math.floor(Math.random() * emptyStateMessages.length)];
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'lark-message message empty-state';
            emptyDiv.innerHTML = `
                <div class="message-label">The Lark</div>
                <div class="message-text">${message}</div>
            `;
            conversation.appendChild(emptyDiv);
        }

        // Crisis Response Rendering
        function renderCrisisResponse(crisisResponse, distressLevel) {
            clearIntro();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message lark-message crisis-response crisis-${distressLevel}`;

            let html = `<div class="message-label">The Lark</div>`;

            // Intro message
            if (crisisResponse.intro) {
                html += `<div class="crisis-intro">${crisisResponse.intro}</div>`;
            }

            // Resources section
            if (crisisResponse.show_resources && crisisResponse.resources) {
                html += `<div class="crisis-resources ${crisisResponse.resources_priority === 'urgent' ? 'urgent' : 'important'}">`;
                html += `<h3 class="resources-header">${crisisResponse.resources_header}</h3>`;
                html += `<ul class="resources-list">`;

                crisisResponse.resources.forEach(resource => {
                    const iconEmoji = resource.icon === 'emergency' ? 'üö®' :
                                      resource.icon === 'text' ? 'üí¨' : 'üìû';
                    html += `<li class="resource-item">
                        <span class="resource-icon">${iconEmoji}</span>
                        <strong>${resource.name}:</strong>
                        <span class="resource-number">${resource.number}</span>
                        <span class="resource-desc">${resource.description}</span>
                    </li>`;
                });

                html += `</ul>`;
                html += `<p class="more-resources"><a href="/resources">More support resources ‚Üí</a></p>`;
                html += `</div>`;
            }

            // Closing message
            if (crisisResponse.closing) {
                html += `<div class="crisis-closing">${crisisResponse.closing}</div>`;
            }

            messageDiv.innerHTML = html;
            conversation.appendChild(messageDiv);

            // Scroll to message
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        // Render venue intro for distress level (before venues)
        function renderDistressVenueIntro(venueIntro) {
            const introDiv = document.createElement('div');
            introDiv.className = 'message lark-message distress-venue-intro';
            introDiv.innerHTML = `
                <div class="message-text venue-intro-text">${venueIntro}</div>
            `;
            conversation.appendChild(introDiv);
        }

        // Render melancholy footer
        function renderMelancholyFooter(footer) {
            const footerDiv = document.createElement('div');
            footerDiv.className = 'melancholy-footer';
            footerDiv.innerHTML = footer.html;
            conversation.appendChild(footerDiv);
        }

        async function askLark() {
            const prompt = userInput.value.trim();

            if (!prompt) return;

            // Disable input
            askButton.disabled = true;
            userInput.disabled = true;

            // Add user message
            addMessage('user', prompt);

            // Clear input
            userInput.value = '';

            // Show fluttering feather loader
            showLoader();

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                // Update dev panel
                if (data.filters) {
                    parseResult.textContent = JSON.stringify(data.filters, null, 2);
                    currentFilters.textContent = JSON.stringify(data.filters, null, 2);
                }

                // Remove loader
                removeLoader();

                if (data.error) {
                    addMessage('lark', data.error);
                }
                // CRISIS LEVEL: Show resources only, no venues
                else if (data.distress_level === 'crisis' && data.crisis_response) {
                    renderCrisisResponse(data.crisis_response, 'crisis');
                }
                // DISTRESS LEVEL: Show resources first, then gentle venues
                else if (data.distress_level === 'distress' && data.crisis_response) {
                    // First render crisis resources
                    renderCrisisResponse(data.crisis_response, 'distress');

                    // Then show venue intro and venues if available
                    if (data.responses && data.responses.length > 0) {
                        setTimeout(() => {
                            if (data.crisis_response.venue_intro) {
                                renderDistressVenueIntro(data.crisis_response.venue_intro);
                            }
                            // Add each venue response
                            data.responses.forEach((resp, index) => {
                                setTimeout(() => {
                                    addMessage('lark', resp.text, {
                                        venue_name: resp.venue_name,
                                        area: resp.area,
                                        website: resp.website,
                                        mood: data.mood,
                                        confidence: data.confidence
                                    });
                                }, (index + 1) * 300);
                            });
                        }, 600); // Delay venues after resources
                    }
                }
                // MELANCHOLY or NORMAL: Regular venue response with optional footer
                else if (data.responses && data.responses.length > 0) {
                    // Add each response with mood badge
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            addMessage('lark', resp.text, {
                                venue_name: resp.venue_name,
                                area: resp.area,
                                website: resp.website,
                                mood: data.mood,
                                confidence: data.confidence
                            });
                        }, index * 300); // Stagger animations
                    });

                    // Add subtle footer for melancholy level
                    if (data.distress_level === 'melancholy' && data.melancholy_footer) {
                        const totalDelay = data.responses.length * 300 + 400;
                        setTimeout(() => {
                            renderMelancholyFooter(data.melancholy_footer);
                        }, totalDelay);
                    }
                } else {
                    showEmptyState();
                }

            } catch (error) {
                removeLoader();
                addMessage('lark', `Something went awry: ${error.message}`);
            }

            // Re-enable input
            askButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        async function surpriseMe() {
            // Clear intro
            clearIntro();

            // Disable buttons
            const surpriseButton = document.getElementById('surpriseButton');
            askButton.disabled = true;
            surpriseButton.disabled = true;

            // Show loader
            showLoader();

            try {
                const response = await fetch('/surprise', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                // Remove loader
                removeLoader();

                if (data.error) {
                    addMessage('lark', data.error);
                } else if (data.response) {
                    // Add surprise response with mood badge and venue info
                    addMessage('lark', data.response, {
                        venue_name: data.venue_name,
                        area: data.area,
                        website: data.website,
                        mood: data.mood,
                        confidence: 1.0
                    });
                }

            } catch (error) {
                removeLoader();
                addMessage('lark', `Something went awry: ${error.message}`);
            }

            // Re-enable buttons
            askButton.disabled = false;
            surpriseButton.disabled = false;
        }

        // Mood Tuner functions
        function toggleMoodTuner() {
            const panel = document.getElementById('moodTuner');
            panel.classList.toggle('open');
        }

        function testMood(mood) {
            // Update button states
            document.querySelectorAll('.test-mood-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === mood) {
                    btn.classList.add('active');
                }
            });

            // Set a test query
            userInput.value = `I want something ${mood.toLowerCase()}`;
            userInput.focus();
        }

        // Close mood tuner with Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const panel = document.getElementById('moodTuner');
                if (panel.classList.contains('open')) {
                    panel.classList.remove('open');
                }
            }
        });
    </script>

    <footer class="main-footer">
        <a href="/about" class="footer-link">About the Lark</a>
        <span class="footer-separator"> ¬∑ </span>
        <a href="/resources" class="footer-link">If you need support</a>
    </footer>
</body>
</html>
