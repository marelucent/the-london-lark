<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The London Lark</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.8;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(232, 232, 232, 0.15);
        }

        h1 {
            font-size: 2.8rem;
            font-weight: 300;
            letter-spacing: 0.15em;
            margin-bottom: 0.8rem;
            color: #f0e68c;
        }

        .tagline {
            font-size: 1rem;
            font-style: italic;
            color: #b8b8b8;
            letter-spacing: 0.08em;
        }

        .conversation {
            margin-bottom: 2rem;
            min-height: 220px;
        }

        .message {
            margin-bottom: 1.8rem;
            padding: 1.4rem;
            border-radius: 10px;
            opacity: 0;
            transform: translateY(15px);
            animation: slideIn 0.6s ease forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: rgba(240, 230, 140, 0.08);
            border-left: 3px solid #f0e68c;
            margin-left: 2.5rem;
            animation-delay: 0s;
        }

        .lark-message {
            background: rgba(176, 196, 222, 0.08);
            border-left: 3px solid #b0c4de;
            margin-right: 2.5rem;
            animation-delay: 0.2s;
        }

        .message-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 0.6rem;
            opacity: 0.6;
        }

        .message-text {
            font-size: 1.1rem;
            line-height: 1.9;
        }

        .venue-details {
            margin-top: 1rem;
            font-size: 0.95rem;
            opacity: 0.85;
            font-style: italic;
        }

        .venue-link {
            color: #f0e68c;
            text-decoration: none;
            border-bottom: 1px solid rgba(240, 230, 140, 0.3);
            transition: all 0.3s ease;
        }

        .venue-link:hover {
            color: #ffd700;
            border-bottom-color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .mood-badge {
            display: inline-block;
            margin-top: 0.8rem;
            padding: 0.35rem 1rem;
            background: rgba(240, 230, 140, 0.15);
            border-radius: 15px;
            font-size: 0.8rem;
            color: #f0e68c;
            letter-spacing: 0.05em;
        }

        .mood-icon {
            margin-right: 0.3em;
        }

        .input-area {
            position: relative;
            margin-top: 2.5rem;
        }

        textarea {
            width: 100%;
            padding: 1.4rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(232, 232, 232, 0.15);
            border-radius: 10px;
            color: #e8e8e8;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.05rem;
            resize: vertical;
            min-height: 110px;
            transition: all 0.4s ease;
            line-height: 1.7;
        }

        textarea:focus {
            outline: none;
            border-color: rgba(240, 230, 140, 0.5);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 0 20px rgba(240, 230, 140, 0.1);
        }

        textarea::placeholder {
            color: rgba(232, 232, 232, 0.35);
            font-style: italic;
        }

        button {
            margin-top: 1.2rem;
            padding: 0.9rem 2.2rem;
            background: linear-gradient(135deg, #f0e68c 0%, #daa520 100%);
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(240, 230, 140, 0.35);
        }

        button:active {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Fluttering feather loader */
        .loading {
            text-align: center;
            padding: 2.5rem;
            font-style: italic;
            opacity: 0.8;
        }

        .feather-loader {
            display: inline-block;
            font-size: 1.8rem;
            animation: flutter 2s ease-in-out infinite;
            margin-bottom: 0.8rem;
        }

        @keyframes flutter {
            0%, 100% {
                transform: rotate(-5deg) translateY(0);
            }
            25% {
                transform: rotate(5deg) translateY(-8px);
            }
            50% {
                transform: rotate(-3deg) translateY(-4px);
            }
            75% {
                transform: rotate(8deg) translateY(-10px);
            }
        }

        .loading-text {
            color: #b0c4de;
            letter-spacing: 0.1em;
            font-size: 1rem;
        }

        .error {
            background: rgba(255, 100, 100, 0.08);
            border-left: 3px solid #ff6464;
            padding: 1.2rem;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .intro {
            text-align: center;
            padding: 3.5rem 2rem;
            font-style: italic;
            opacity: 0.75;
            font-size: 1.15rem;
            line-height: 2;
        }

        .intro small {
            display: block;
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Empty state / no matches */
        .empty-state {
            text-align: center;
            padding: 2rem;
            font-style: italic;
            color: #b0c4de;
            line-height: 1.9;
        }

        /* Dev Mood Tuner Panel */
        .dev-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(240, 230, 140, 0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            color: #f0e68c;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .dev-toggle:hover {
            opacity: 1;
        }

        .mood-tuner {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(22, 33, 62, 0.98);
            border-left: 1px solid rgba(240, 230, 140, 0.3);
            padding: 1.5rem;
            overflow-y: auto;
            transition: right 0.4s ease;
            z-index: 1000;
        }

        .mood-tuner.open {
            right: 0;
        }

        .mood-tuner h3 {
            color: #f0e68c;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            letter-spacing: 0.1em;
        }

        .mood-tuner .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #e8e8e8;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .mood-tuner .close-btn:hover {
            opacity: 1;
        }

        .parse-result {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .parse-result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .mood-slider {
            margin-bottom: 1rem;
        }

        .mood-slider label {
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.85rem;
            color: #b0c4de;
        }

        .mood-slider input[type="range"] {
            width: 100%;
            margin-top: 0.3rem;
        }

        .test-moods {
            margin-top: 1.5rem;
        }

        .test-mood-btn {
            display: inline-block;
            margin: 0.3rem;
            padding: 0.4rem 0.8rem;
            background: rgba(176, 196, 222, 0.2);
            border: 1px solid rgba(176, 196, 222, 0.3);
            border-radius: 15px;
            color: #b0c4de;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-mood-btn:hover {
            background: rgba(176, 196, 222, 0.4);
            color: #e8e8e8;
        }

        .test-mood-btn.active {
            background: rgba(240, 230, 140, 0.3);
            border-color: #f0e68c;
            color: #f0e68c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üïäÔ∏è THE LONDON LARK</h1>
            <p class="tagline">A poetic companion for London's cultural undercurrent</p>
        </header>

        <div class="conversation" id="conversation">
            <div class="intro">
                Tell me what kind of evening you're dreaming of...<br>
                <small>Perhaps a tender night of folk songs, or somewhere strange and candlelit?</small>
            </div>
        </div>

        <div class="input-area">
            <textarea
                id="userInput"
                placeholder="What kind of evening are you seeking, petal?"
                rows="3"
            ></textarea>
            <button id="askButton" onclick="askLark()">Ask the Lark</button>
        </div>
    </div>

    <!-- Dev Mood Tuner Toggle -->
    <button class="dev-toggle" onclick="toggleMoodTuner()">üîß Mood Tuner</button>

    <!-- Mood Tuner Panel -->
    <div class="mood-tuner" id="moodTuner">
        <button class="close-btn" onclick="toggleMoodTuner()">√ó</button>
        <h3>üé≠ Mood Tuner</h3>

        <div class="parse-result">
            <strong>Last Parse Result:</strong>
            <pre id="parseResult">No query yet...</pre>
        </div>

        <div class="test-moods">
            <strong style="font-size: 0.85rem; color: #b0c4de;">Test Moods:</strong><br>
            <button class="test-mood-btn" onclick="testMood('Folk & Intimate')">Folk & Intimate</button>
            <button class="test-mood-btn" onclick="testMood('Queer Revelry')">Queer Revelry</button>
            <button class="test-mood-btn" onclick="testMood('Melancholic Beauty')">Melancholic Beauty</button>
            <button class="test-mood-btn" onclick="testMood('Late-Night Lark')">Late-Night Lark</button>
            <button class="test-mood-btn" onclick="testMood('Curious Encounters')">Curious Encounters</button>
            <button class="test-mood-btn" onclick="testMood('The Thoughtful Stage')">The Thoughtful Stage</button>
            <button class="test-mood-btn" onclick="testMood('Global Rhythms')">Global Rhythms</button>
            <button class="test-mood-btn" onclick="testMood('Cabaret & Glitter')">Cabaret & Glitter</button>
        </div>

        <div style="margin-top: 1.5rem;">
            <strong style="font-size: 0.85rem; color: #b0c4de;">Current Filters:</strong>
            <pre id="currentFilters" style="background: rgba(0,0,0,0.3); padding: 0.8rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.8rem;">None</pre>
        </div>
    </div>

    <script>
        const conversation = document.getElementById('conversation');
        const userInput = document.getElementById('userInput');
        const askButton = document.getElementById('askButton');
        const parseResult = document.getElementById('parseResult');
        const currentFilters = document.getElementById('currentFilters');

        // Mood to icon mapping
        const moodIcons = {
            'Folk & Intimate': 'üåø',
            'Queer Revelry': 'üåà',
            'Melancholic Beauty': 'üåô',
            'Late-Night Lark': 'ü¶â',
            'Curious Encounters': '‚ú®',
            'The Thoughtful Stage': 'üé≠',
            'Global Rhythms': 'üåç',
            'Cabaret & Glitter': 'üí´',
            'Poetic': 'üìú',
            'Punchy / Protest': 'üî•',
            'Big Night Out': 'üéâ',
            'Comic Relief': 'üòÑ',
            'Dreamlike & Hypnagogic': 'üí≠',
            'Wonder & Awe': 'üåü',
            'Spiritual / Sacred / Mystical': 'üïØÔ∏è',
            'Playful & Weird': 'üé™',
            'Nostalgic / Vintage / Retro': 'üìª',
            'Body-Based / Movement-Led': 'üíÉ',
            'Grief & Grace': 'üïäÔ∏è',
            'Witchy & Wild': 'üåõ'
        };

        // Poetic empty state messages
        const emptyStateMessages = [
            "The wind found no doors tonight, petal. Try another path.",
            "Even the Lark must sometimes rest her wings. No matches found.",
            "The city hums, but not in that key tonight. Seek elsewhere.",
            "No feathers stirred for this request. Perhaps rephrase your longing?",
            "The map is vast, but this corner lies silent. Ask again differently."
        ];

        // Focus input on load
        userInput.focus();

        // Allow Enter to submit (Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askLark();
            }
        });

        function clearIntro() {
            const intro = conversation.querySelector('.intro');
            if (intro) {
                intro.remove();
            }
        }

        function getMoodIcon(mood) {
            return moodIcons[mood] || 'üéµ';
        }

        function addMessage(type, content, details = {}) {
            clearIntro();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            let html = `<div class="message-label">${type === 'user' ? 'You' : 'The Lark'}</div>`;
            html += `<div class="message-text">${content}</div>`;

            if (details.venue_name) {
                const venueName = details.venue_name;
                const area = details.area ? ' in ' + details.area : '';
                const website = details.website;

                // Make venue name clickable if website exists
                if (website && website !== '(n/a ‚Äî pub site or folk club listing)' && website.trim() && !website.startsWith('(')) {
                    let url = website;
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        url = 'https://' + url;
                    }
                    html += `<div class="venue-details">üìç <a href="${url}" target="_blank" rel="noopener noreferrer" class="venue-link">${venueName}</a>${area}</div>`;
                } else {
                    html += `<div class="venue-details">üìç ${venueName}${area}</div>`;
                }
            }

            if (details.mood) {
                const icon = getMoodIcon(details.mood);
                const confidenceText = details.confidence < 1.0 ? ` ¬∑ ${Math.round(details.confidence * 100)}%` : '';
                html += `<div class="mood-badge"><span class="mood-icon">${icon}</span>${details.mood}${confidenceText}</div>`;
            }

            messageDiv.innerHTML = html;
            conversation.appendChild(messageDiv);

            // Scroll to bottom
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        function showLoader() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'currentLoader';
            loadingDiv.innerHTML = `
                <div class="feather-loader">ü™∂</div>
                <div class="loading-text">The Lark is composing...</div>
            `;
            conversation.appendChild(loadingDiv);
            loadingDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return loadingDiv;
        }

        function removeLoader() {
            const loader = document.getElementById('currentLoader');
            if (loader) loader.remove();
        }

        function showEmptyState() {
            const message = emptyStateMessages[Math.floor(Math.random() * emptyStateMessages.length)];
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'lark-message message empty-state';
            emptyDiv.innerHTML = `
                <div class="message-label">The Lark</div>
                <div class="message-text">${message}</div>
            `;
            conversation.appendChild(emptyDiv);
        }

        async function askLark() {
            const prompt = userInput.value.trim();

            if (!prompt) return;

            // Disable input
            askButton.disabled = true;
            userInput.disabled = true;

            // Add user message
            addMessage('user', prompt);

            // Clear input
            userInput.value = '';

            // Show fluttering feather loader
            showLoader();

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                // Update dev panel
                if (data.filters) {
                    parseResult.textContent = JSON.stringify(data.filters, null, 2);
                    currentFilters.textContent = JSON.stringify(data.filters, null, 2);
                }

                // Remove loader
                removeLoader();

                if (data.error) {
                    addMessage('lark', data.error);
                } else if (data.responses && data.responses.length > 0) {
                    // Add each response with mood badge
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            addMessage('lark', resp.text, {
                                venue_name: resp.venue_name,
                                area: resp.area,
                                website: resp.website,
                                mood: data.mood,
                                confidence: data.confidence
                            });
                        }, index * 300); // Stagger animations
                    });
                } else {
                    showEmptyState();
                }

            } catch (error) {
                removeLoader();
                addMessage('lark', `Something went awry: ${error.message}`);
            }

            // Re-enable input
            askButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        // Mood Tuner functions
        function toggleMoodTuner() {
            const panel = document.getElementById('moodTuner');
            panel.classList.toggle('open');
        }

        function testMood(mood) {
            // Update button states
            document.querySelectorAll('.test-mood-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === mood) {
                    btn.classList.add('active');
                }
            });

            // Set a test query
            userInput.value = `I want something ${mood.toLowerCase()}`;
            userInput.focus();
        }

        // Close mood tuner with Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const panel = document.getElementById('moodTuner');
                if (panel.classList.contains('open')) {
                    panel.classList.remove('open');
                }
            }
        });
    </script>
</body>
</html>
