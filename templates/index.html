<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The London Lark</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ============================================
           SAFETY COMPONENT STYLES
           ============================================ */
        
        /* Soft Footer (Tier 2 - Emotional) */
        .safety-soft-footer {
            margin-top: 2rem;
            padding: 1rem 1.5rem;
            background: rgba(212, 175, 55, 0.05);
            border-left: 2px solid rgba(212, 175, 55, 0.3);
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.8;
        }
        
        .safety-soft-footer a {
            color: var(--gold, #d4af37);
            text-decoration: none;
        }
        
        .safety-soft-footer a:hover {
            text-decoration: underline;
        }
        
        /* Support Box (Tier 3 - Distress) */
        .safety-support-box {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(106, 106, 122, 0.15) 0%, rgba(26, 23, 20, 0.9) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }
        
        .safety-support-box .lark-says {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--cream, #f5f0e6);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .support-links {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .support-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 3px;
            color: var(--candlelight, #f4e4bc);
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .support-link:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold, #d4af37);
        }
        
        .more-link {
            color: var(--gold, #d4af37);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .more-link:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        /* Crisis Box (Tier 4 - Crisis) */
        .safety-crisis-box {
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(13, 13, 13, 0.95) 0%, rgba(26, 23, 20, 0.98) 100%);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 4px;
        }
        
        .crisis-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .crisis-icon {
            font-size: 1.5rem;
        }
        
        .crisis-title {
            font-family: var(--font-title, 'Cinzel', serif);
            font-size: 1rem;
            letter-spacing: 0.15em;
            color: var(--gold, #d4af37);
        }
        
        .safety-crisis-box .lark-says {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.15rem;
            font-style: italic;
            color: var(--cream, #f5f0e6);
            margin-bottom: 1.5rem;
            line-height: 1.7;
        }
        
        .crisis-contacts {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .crisis-contact {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 3px;
        }
        
        .contact-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .contact-name {
            font-family: var(--font-title, 'Cinzel', serif);
            font-size: 0.9rem;
            color: var(--gold, #d4af37);
            letter-spacing: 0.05em;
        }
        
        .contact-number {
            font-size: 1.1rem;
            color: var(--cream, #f5f0e6);
        }
        
        .contact-number a {
            color: var(--cream, #f5f0e6);
            text-decoration: none;
        }
        
        .contact-number a:hover {
            color: var(--gold, #d4af37);
        }
        
        .contact-note {
            font-size: 0.85rem;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.7;
        }
        
        .venue-offer {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.8;
            margin-top: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .support-links {
                flex-direction: column;
                align-items: flex-start;
            }

            .crisis-contact {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* ============================================
           ASK VIEW - CONVERSATION FIRST
           ============================================ */

        .ask-intro {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
        }

        .ask-intro-text {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.15rem;
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            line-height: 1.8;
            max-width: 500px;
            margin: 0 auto;
            opacity: 0.9;
        }

        .ask-fallback {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
        }

        .fallback-label {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 0.95rem;
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.6;
            display: block;
            margin-bottom: 1rem;
        }

        .fallback-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }

        .fallback-link {
            font-family: var(--font-title, 'Cinzel', serif);
            font-size: 0.85rem;
            letter-spacing: 0.1em;
            color: var(--gold, #d4af37);
            text-decoration: none;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .fallback-link:hover {
            opacity: 1;
        }

        /* Placeholder fade animation */
        #userInput {
            transition: opacity 0.3s ease;
        }

        #userInput.placeholder-fade {
            opacity: 0.7;
        }

        /* ============================================
           CARE PATHWAY STYLES
           ============================================ */

        .care-pathway-container {
            text-align: center;
            padding: 2rem 1rem;
        }

        .care-preamble {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.25rem;
            font-style: italic;
            color: var(--gold, #d4af37);
            line-height: 1.8;
            margin-bottom: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .care-choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-width: 400px;
            margin: 0 auto 2rem auto;
        }

        @media (max-width: 500px) {
            .care-choices {
                grid-template-columns: 1fr;
                max-width: 280px;
            }
        }

        .care-choice-btn {
            padding: 1rem 1.25rem;
            background: rgba(26, 23, 20, 0.9);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 3px;
            color: var(--candlelight, #f4e4bc);
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1rem;
            font-style: italic;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .care-choice-btn:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--gold, #d4af37);
            color: var(--gold, #d4af37);
        }

        .care-choice-btn:active {
            transform: scale(0.98);
        }

        /* ============================================
           TEXTURE CARDS (Context-Aware Care Pathways)
           ============================================ */

        .texture-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            max-width: 700px;
            margin: 0 auto 2rem auto;
            padding: 0 1rem;
        }

        @media (max-width: 700px) {
            .texture-cards {
                grid-template-columns: repeat(2, 1fr);
                max-width: 340px;
            }
        }

        @media (max-width: 400px) {
            .texture-cards {
                grid-template-columns: 1fr;
                max-width: 180px;
            }
        }

        .texture-card {
            position: relative;
            padding: 1.5rem 1rem;
            min-height: 140px;
            background: linear-gradient(135deg, rgba(13,13,13,0.9) 0%, rgba(26,23,20,0.95) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
        }

        /* Corner flourishes (like venue cards) */
        .texture-card::before,
        .texture-card::after,
        .texture-card .corner-tr,
        .texture-card .corner-bl {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            border-color: rgba(212, 175, 55, 0.4);
            border-style: solid;
            transition: all 0.3s ease;
        }

        .texture-card::before {
            top: 6px;
            left: 6px;
            border-width: 1px 0 0 1px;
        }

        .texture-card::after {
            bottom: 6px;
            right: 6px;
            border-width: 0 1px 1px 0;
        }

        .texture-card .corner-tr {
            top: 6px;
            right: 6px;
            border-width: 1px 1px 0 0;
        }

        .texture-card .corner-bl {
            bottom: 6px;
            left: 6px;
            border-width: 0 0 1px 1px;
        }

        .texture-card:hover {
            transform: translateY(-4px);
            border-color: var(--gold, #d4af37);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.2);
        }

        .texture-card:hover::before,
        .texture-card:hover::after,
        .texture-card:hover .corner-tr,
        .texture-card:hover .corner-bl {
            border-color: var(--gold, #d4af37);
        }

        .texture-card:active {
            transform: translateY(-2px);
        }

        .texture-icon {
            font-size: 1.8rem;
            color: var(--gold, #d4af37);
            margin-bottom: 0.75rem;
            line-height: 1;
            opacity: 0.9;
        }

        .texture-phrase {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 0.95rem;
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            line-height: 1.4;
            max-width: 100%;
        }

        .texture-card:hover .texture-icon {
            opacity: 1;
        }

        .texture-card:hover .texture-phrase {
            color: var(--gold, #d4af37);
        }

        /* Resources footer for Tier 3 */
        .resources-footer {
            margin-top: 2rem;
            padding: 1.5rem;
            text-align: center;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
        }

        /* Warmer resources footer - "here if you need" not "WARNING" */
        .resources-footer-warm {
            margin-top: 2.5rem;
            padding: 1.5rem 1rem;
            text-align: center;
            border-top: none;
            border-radius: 4px;
            background: transparent;
        }

        .resources-footer-text {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1rem;
            font-style: italic;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.9;
            margin-bottom: 1rem;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        .resources-footer-warm .resources-footer-text {
            font-size: 1.05rem;
            opacity: 0.85;
            color: var(--candlelight, #f4e4bc);
        }

        .resources-footer-contacts {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            font-size: 0.9rem;
        }

        .resources-footer-warm .resources-footer-contacts {
            gap: 1rem;
            font-size: 0.85rem;
            opacity: 0.75;
        }

        .resources-footer-contacts a {
            color: var(--gold, #d4af37);
            text-decoration: none;
        }

        .resources-footer-contacts a:hover {
            text-decoration: underline;
        }

        .resources-footer-contacts span {
            color: var(--candlelight, #f4e4bc);
            opacity: 0.7;
        }

        .resources-footer-warm .resources-footer-contacts span {
            opacity: 1;
        }

        /* Separator between contacts */
        .resources-footer-warm .resources-footer-contacts span:not(:last-child)::after {
            content: '¬∑';
            margin-left: 1rem;
            color: rgba(212, 175, 55, 0.4);
        }

        @media (max-width: 500px) {
            .resources-footer-contacts {
                flex-direction: column;
                gap: 0.75rem;
            }
            .resources-footer-warm .resources-footer-contacts span:not(:last-child)::after {
                display: none;
            }
        }

        /* ============================================
           LARK PREAMBLE (Opening Line)
           ============================================ */

        .lark-preamble-section {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 1rem;
        }

        .lark-opening-line {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.4rem;
            font-style: italic;
            color: var(--gold, #d4af37);
            line-height: 1.8;
            margin: 0 0 1rem 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .user-whispered {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1rem;
            color: var(--candlelight, #f4e4bc);
            opacity: 0.7;
            margin: 0;
        }

        .user-whispered em {
            color: var(--cream, #f5f0e6);
            opacity: 1;
        }

        /* ============================================
           CLARIFICATION PROMPT STYLES
           ============================================ */

        .lark-clarification {
            text-align: center;
            padding: 2rem 1rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .lark-asks {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.4rem;
            font-style: italic;
            color: var(--gold, #d4af37);
            line-height: 1.8;
            margin: 0;
        }

        /* ============================================
           NULL STATE STYLES
           ============================================ */

        .null-state-container {
            text-align: center;
            padding: 2rem 1rem;
        }

        .null-preamble {
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1.2rem;
            font-style: italic;
            color: var(--gold, #d4af37);
            line-height: 1.8;
            margin-bottom: 2rem;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
        }

        .null-choices {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            max-width: 280px;
            margin: 0 auto;
        }

        .null-choice-btn {
            width: 100%;
            padding: 0.9rem 1.5rem;
            background: rgba(26, 23, 20, 0.9);
            border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 3px;
            color: var(--candlelight, #f4e4bc);
            font-family: var(--font-whisper, 'Cormorant Garamond', serif);
            font-size: 1rem;
            font-style: italic;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .null-choice-btn:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--gold, #d4af37);
            color: var(--gold, #d4af37);
        }

        .null-choice-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- HEADER - The Lark's Mark -->
        <header>
            <h1 onclick="returnToEntrance()" style="cursor: pointer;">‚ú¶ THE LONDON LARK ‚ú¶</h1>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="mainContent">
            
            <!-- ENTRANCE: Search-First Portal -->
            <section id="entranceView" class="view active">
                <div class="entrance-content">
                    <h2 class="lark-headline">"I know the places that change you."</h2>
                    <p class="lark-subline">A poetic guide to London's hidden doors.</p>

                    <p class="entrance-greeting" id="entranceGreeting"></p>

                    <div class="entrance-search">
                        <textarea
                            id="entranceInput"
                            placeholder="cosy, with candles and wine..."
                            rows="2"
                        ></textarea>
                        <button id="entranceButton" onclick="entranceAsk()">Whisper to the Lark</button>
                    </div>

                    <div class="entrance-alternatives">
                        <span class="alternatives-label">or if you'd rather...</span>
                        <div class="alternatives-links">
                            <a href="#" onclick="choosePath('draw'); return false;" class="alt-link">‚ú¶ Draw a Card</a>
                            <span class="alt-separator">„Éª</span>
                            <a href="#" onclick="choosePath('browse'); return false;" class="alt-link">‚ò∞ Browse the Deck</a>
                        </div>
                    </div>

                    <a href="/about" class="who-is-she-link">‚Äî who is she? ‚Äî</a>
                </div>
            </section>

            <!-- DRAW A CARD VIEW -->
            <section id="drawView" class="view">
                <div class="draw-container">
                    <!-- Face-down card -->
                    <div class="arcana-card card-lg face-down" id="drawnCard" onclick="revealCard(currentArcana)">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-back-symbol">‚ú¶</div>
                        <div class="card-back-prompt">tap when you're ready</div>
                    </div>
                    
                    <!-- Revealed card (hidden initially) -->
                    <div class="arcana-card card-lg" id="revealedCard" style="display: none;">
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-inner">
                            <div class="arcana-symbol" id="cardArcanaSymbol"></div>
                            <div class="arcana-number" id="cardArcanaNumber"></div>
                            <div class="arcana-name" id="cardArcanaName"></div>
                            <div class="arcana-mood" id="cardArcanaMood"></div>
                            <div class="arcana-divider"></div>
                            <div class="venue-section">
                                <div class="venue-name" id="cardVenueName"></div>
                                <div class="venue-location" id="cardVenueLocation"></div>
                                <div class="venue-blurb" id="cardVenueBlurb"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Draw actions -->
                <div class="draw-actions" id="drawActions" style="display: none;">
                    <button class="action-btn" onclick="drawAnother()">Draw Another</button>
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back</button>
                </div>
            </section>

            <!-- ASK THE LARK VIEW -->
            <section id="askView" class="view">
                <!-- Results area (above input) -->
                <div class="results-container" id="askResults"></div>

                <div class="ask-container">
                    <!-- First visit intro (hidden for return visitors) -->
                    <div class="ask-intro" id="askIntro">
                        <p class="ask-intro-text">I know the places that change you. The rooms that hum with something. Tell me what you're after ‚Äî or let me draw for you.</p>
                    </div>

                    <!-- Greeting line (different for first/return visits) -->
                    <p class="ask-prompt" id="askPrompt">What kind of night are you after?</p>

                    <div class="ask-input-area">
                        <textarea
                            id="userInput"
                            placeholder="somewhere witchy and weird..."
                            rows="3"
                        ></textarea>
                        <button id="askButton" onclick="askLark()">Whisper to the Lark</button>
                    </div>

                    <!-- Fallback options -->
                    <div class="ask-fallback">
                        <span class="fallback-label">or if you'd rather...</span>
                        <div class="fallback-links">
                            <a href="#" onclick="choosePath('draw'); return false;" class="fallback-link">‚ú¶ Draw a card</a>
                            <a href="#" onclick="choosePath('browse'); return false;" class="fallback-link">‚ò∞ Browse the deck</a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- BROWSE THE DECK VIEW -->
            <section id="browseView" class="view">
                <div class="browse-container">
                    <p class="browse-prompt">The Full Deck</p>
                    <p class="browse-subtext">23 paths through London's soul. Choose your arcana.</p>
                    
                    <!-- Arcana Grid -->
                    <div class="arcana-grid" id="arcanaGrid">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <div class="browse-actions">
                        <button class="action-btn secondary" onclick="returnToEntrance()">Back</button>
                    </div>
                </div>
            </section>

            <!-- ARCANA VENUES VIEW (after clicking an arcana card) -->
            <section id="arcanaVenuesView" class="view">
                <div class="arcana-venues-container">
                    <div class="arcana-venues-header" id="arcanaVenuesHeader">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <div class="arcana-venues-list" id="arcanaVenuesList">
                        <!-- Populated dynamically -->
                    </div>
                    
                    <div class="arcana-venues-actions">
                        <button class="action-btn" onclick="drawFromArcana()">Draw from this Arcana</button>
                        <button class="action-btn secondary" onclick="showView('browse')">Back to Deck</button>
                    </div>
                </div>
            </section>

            <!-- CRISIS RESPONSE VIEW -->
            <section id="crisisView" class="view">
                <div class="crisis-container" id="crisisContent">
                    <!-- Populated dynamically -->
                </div>
                <div class="crisis-actions">
                    <button class="action-btn secondary" onclick="returnToEntrance()">Back</button>
                </div>
            </section>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="feather-loader">ü™∂</div>
        <p class="loading-text">The Lark is listening...</p>
    </div>

    <footer class="main-footer">
        <a href="/about" class="footer-link">About the Lark</a>
        <span class="footer-separator"> ¬∑ </span>
        <a href="/resources" class="footer-link">If you need support</a>
    </footer>

    <script>
        // ============================================
        // STATE
        // ============================================
        let currentView = 'ask';
        let currentCardData = null;
        let currentArcana = null;
        let placeholderInterval = null;
        let currentSafetyTier = null;  // Tracks current emotional tier for care pathway

        // Time-aware greetings for return visitors
        // Each entry is { greeting: "...", followup: "..." } to ensure time-appropriate phrasing
        const timeGreetings = {
            morning: [
                { greeting: "The morning light found you here again.", followup: "What are you dreaming of?" },
                { greeting: "Back before noon ‚Äî I like your style.", followup: "What are you seeking?" },
                { greeting: "Early bird, seeking worms of wonder.", followup: "What calls to you this morning?" }
            ],
            afternoon: [
                { greeting: "The afternoon brought you back.", followup: "What does your afternoon need?" },
                { greeting: "Midday wanderer.", followup: "What calls to you?" },
                { greeting: "The city hums. So do you.", followup: "What are you after?" }
            ],
            evening: [
                { greeting: "The evening stirs something, doesn't it?", followup: "What is it tonight?" },
                { greeting: "Night approaches.", followup: "Where shall we send you?" },
                { greeting: "The gloaming hour ‚Äî my favourite.", followup: "What is it tonight?" }
            ],
            latenight: [
                { greeting: "The late hours have their own magic.", followup: "What is it tonight?" },
                { greeting: "Still awake? So am I.", followup: "What are you seeking?" },
                { greeting: "The city's second life is beginning.", followup: "Where will you wander?" }
            ]
        };

        // Cycling placeholders for search box
        const askPlaceholders = [
            "somewhere witchy and weird...",
            "I want to feel alive tonight...",
            "cosy, with candles and wine...",
            "I don't know ‚Äî surprise me..."
        ];

        // Arcana mapping for display (with symbols!)
        const arcanaMap = {
            'Playful & Weird': { number: '0', name: 'THE FOOL', symbol: '‚óå' },
            'Curious Encounters': { number: 'I', name: 'THE MAGICIAN', symbol: '‚òø' },
            'Witchy & Wild': { number: 'II', name: 'THE HIGH PRIESTESS', symbol: 'ìÇÄ' },
            'Folk & Intimate': { number: 'III', name: 'THE EMPRESS', symbol: '‚öò' },
            'The Thoughtful Stage': { number: 'IV', name: 'THE EMPEROR', symbol: '‚óÜ' },
            'Spiritual / Sacred / Mystical': { number: 'V', name: 'THE HIEROPHANT', symbol: '‚ö∑' },
            'Cabaret & Glitter': { number: 'VI', name: 'THE LOVERS', symbol: '‚öØ' },
            'Big Night Out': { number: 'VII', name: 'THE CHARIOT', symbol: '‚Üë' },
            'Punchy / Protest': { number: 'VIII', name: 'STRENGTH', symbol: '‚àû' },
            'Contemplative & Meditative': { number: 'IX', name: 'THE HERMIT', symbol: '‚ü°' },
            'Global Rhythms': { number: 'X', name: 'WHEEL OF FORTUNE', symbol: '‚óé' },
            'Rant & Rapture': { number: 'XI', name: 'JUSTICE', symbol: '‚öñ' },
            'Body-Based / Movement-Led': { number: 'XII', name: 'THE HANGED MAN', symbol: '‚à¥' },
            'Grief & Grace': { number: 'XIII', name: 'DEATH', symbol: '‚úø' },
            'Word & Voice': { number: 'XIV', name: 'TEMPERANCE', symbol: '‚âã' },
            'Late-Night Lark': { number: 'XV', name: 'THE DEVIL', symbol: '‚õß' },
            'Melancholic Beauty': { number: 'XVI', name: 'THE TOWER', symbol: '‚ÜØ' },
            'Wonder & Awe': { number: 'XVII', name: 'THE STAR', symbol: '‚ú¶' },
            'Nostalgic / Vintage / Retro': { number: 'XVIII', name: 'THE MOON', symbol: '‚òæ' },
            'Comic Relief': { number: 'XIX', name: 'THE SUN', symbol: '‚òÄ' },
            'Group Energy': { number: 'XX', name: 'JUDGEMENT', symbol: '‚ñ≥' },
            'Queer Revelry': { number: 'XXI', name: 'THE WORLD', symbol: '‚óâ' },
            'Romanticised London': { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' }
        };

        // Arcana whispers (taglines for each card)
        const arcanaWhispers = {
            'Playful & Weird': "Fall sideways into something strange",
            'Curious Encounters': "Everything you need is already here",
            'Witchy & Wild': "The moon knows. The woods know.",
            'Folk & Intimate': "Warm strings and stories like home",
            'The Thoughtful Stage': "Theatre that makes you lean in",
            'Spiritual / Sacred / Mystical': "Where the veil thins and reverence rises",
            'Cabaret & Glitter': "Feathers, fire, wit and want",
            'Big Night Out': "The night is a vehicle and you're at the wheel",
            'Punchy / Protest': "Voices raised, truth revealed",
            'Contemplative & Meditative': "Slow, still, deeply felt",
            'Global Rhythms': "Borders blur and culture sings",
            'Rant & Rapture': "Electrifying expression, righteous fire",
            'Body-Based / Movement-Led': "When words aren't enough",
            'Grief & Grace': "For when you need to feel the ache",
            'Word & Voice': "Language that shimmers",
            'Late-Night Lark': "The city stays up with you",
            'Melancholic Beauty': "Beauty that breaks your heart",
            'Wonder & Awe': "Feel small and lit from within",
            'Nostalgic / Vintage / Retro': "A portal to another era",
            'Comic Relief': "The belly-laugh you didn't know you needed",
            'Group Energy': "The crowd becoming one",
            'Queer Revelry': "Sequins, sweat, and chosen family",
            'Romanticised London': "London as you imagined it in books"
        };

        // ============================================
        // VIEW MANAGEMENT
        // ============================================
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Show requested view
            const view = document.getElementById(viewName + 'View');
            if (view) {
                view.classList.add('active');
                currentView = viewName;
            }
        }

        function returnToEntrance() {
            // Return to Ask view (conversation-first default)
            showView('ask');
            setupAskView();
            // Reset draw card state
            document.getElementById('drawnCard').style.display = 'flex';
            document.getElementById('revealedCard').style.display = 'none';
            document.getElementById('drawActions').style.display = 'none';
            // Clear ask results
            document.getElementById('askResults').innerHTML = '';
            document.getElementById('userInput').value = '';
        }

        // Handle search from entrance page
        function entranceAsk() {
            const entranceInput = document.getElementById('entranceInput');
            const prompt = entranceInput.value.trim();

            if (!prompt) return;

            // Switch to ask view
            showView('ask');
            setupAskView();

            // Copy the prompt to ask view input and trigger search
            document.getElementById('userInput').value = prompt;
            askLark();

            // Clear entrance input for next time
            entranceInput.value = '';
        }

        // ============================================
        // PATH SELECTION
        // ============================================
        function choosePath(path) {
            switch(path) {
                case 'draw':
                    markAsVisited();
                    showView('draw');
                    // Reset card to face-down
                    document.getElementById('drawnCard').style.display = 'flex';
                    document.getElementById('revealedCard').style.display = 'none';
                    document.getElementById('drawActions').style.display = 'none';
                    stopPlaceholderCycle();
                    break;
                case 'ask':
                    showView('ask');
                    setupAskView();
                    document.getElementById('userInput').focus();
                    break;
                case 'browse':
                    markAsVisited();
                    showView('browse');
                    loadFullDeck();
                    stopPlaceholderCycle();
                    break;
            }
        }

        // ============================================
        // ASK VIEW SETUP - First/Return Visit Logic
        // ============================================
        function setupAskView() {
            const isFirstVisit = !localStorage.getItem('lark_visited');
            const introEl = document.getElementById('askIntro');
            const promptEl = document.getElementById('askPrompt');

            if (isFirstVisit) {
                // First visit: show intro, standard question
                introEl.style.display = 'block';
                promptEl.textContent = 'What kind of night are you after?';
                // Note: lark_visited is set when user takes action (search/draw/browse)
            } else {
                // Return visit: hide intro, time-aware greeting with appropriate followup
                introEl.style.display = 'none';
                const timeData = getTimeGreeting();
                promptEl.textContent = timeData.greeting + ' ' + timeData.followup;
            }

            // Start cycling placeholders
            startPlaceholderCycle();
        }

        function markAsVisited() {
            localStorage.setItem('lark_visited', 'true');
        }

        function getTimeGreeting() {
            const hour = new Date().getHours();
            let period;
            if (hour >= 5 && hour < 12) period = 'morning';
            else if (hour >= 12 && hour < 17) period = 'afternoon';
            else if (hour >= 17 && hour < 22) period = 'evening';
            else period = 'latenight';

            const greetings = timeGreetings[period];
            const selected = greetings[Math.floor(Math.random() * greetings.length)];
            // Return object with greeting and time-appropriate followup
            return selected;
        }

        function startPlaceholderCycle() {
            const input = document.getElementById('userInput');
            let index = 0;

            // Set initial placeholder
            input.placeholder = askPlaceholders[index];

            // Clear any existing interval
            stopPlaceholderCycle();

            // Cycle through placeholders every 3.5 seconds
            placeholderInterval = setInterval(() => {
                // Only cycle if input is empty and focused or not focused
                if (input.value === '') {
                    input.classList.add('placeholder-fade');
                    setTimeout(() => {
                        index = (index + 1) % askPlaceholders.length;
                        input.placeholder = askPlaceholders[index];
                        input.classList.remove('placeholder-fade');
                    }, 300);
                }
            }, 3500);
        }

        function stopPlaceholderCycle() {
            if (placeholderInterval) {
                clearInterval(placeholderInterval);
                placeholderInterval = null;
            }
        }

        // ============================================
        // BROWSE THE DECK - FULL DECK VIEW
        // ============================================
        async function loadFullDeck() {
            const grid = document.getElementById('arcanaGrid');
            
            // Show loading state
            grid.innerHTML = '<p class="loading-deck">Shuffling the deck...</p>';
            
            try {
                const response = await fetch('/arcana');
                const data = await response.json();
                
                if (data.error) {
                    grid.innerHTML = '<p class="error-state">The deck scattered... try again?</p>';
                    return;
                }
                
                // Clear and populate grid
                grid.innerHTML = '';
                
                // Sort by arcana order (0, I, II, III, etc.)
                const arcanaOrder = [
                    'Playful & Weird', 'Curious Encounters', 'Witchy & Wild', 'Folk & Intimate',
                    'The Thoughtful Stage', 'Spiritual / Sacred / Mystical', 'Cabaret & Glitter',
                    'Big Night Out', 'Punchy / Protest', 'Contemplative & Meditative', 'Global Rhythms',
                    'Rant & Rapture', 'Body-Based / Movement-Led', 'Grief & Grace', 'Word & Voice',
                    'Late-Night Lark', 'Melancholic Beauty', 'Wonder & Awe', 'Nostalgic / Vintage / Retro',
                    'Comic Relief', 'Group Energy', 'Queer Revelry', 'Romanticised London'
                ];
                
                arcanaOrder.forEach((mood, index) => {
                    const arcanaData = data.arcana.find(a => a.mood === mood);
                    if (arcanaData) {
                        const card = createArcanaCard(arcanaData, index);
                        grid.appendChild(card);
                    }
                });
                
            } catch (error) {
                grid.innerHTML = `<p class="error-state">Something went awry: ${error.message}</p>`;
            }
        }

        function createArcanaCard(arcanaData, index) {
            const arcana = arcanaMap[arcanaData.mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
            const whisper = arcanaWhispers[arcanaData.mood] || '';
            const arcanaKey = getArcanaKey(arcanaData.mood);
            
            const card = document.createElement('div');
            card.className = 'arcana-card card-sm';
            card.setAttribute('data-arcana', arcanaKey);
            card.onclick = () => showArcanaVenues(arcanaData.mood);
            
            // Staggered animation
            card.style.animationDelay = `${index * 50}ms`;
            
            card.innerHTML = `
                <span class="corner-tr"></span>
                <span class="corner-bl"></span>
                <div class="card-inner">
                    <div class="arcana-symbol">${arcana.symbol}</div>
                    <div class="arcana-number">${arcana.number}</div>
                    <div class="arcana-name">${arcana.name}</div>
                    <div class="arcana-mood">${arcanaData.mood}</div>
                    <div class="arcana-count">${arcanaData.venue_count} venues</div>
                </div>
            `;
            
            return card;
        }

        // ============================================
        // ARCANA VENUES VIEW
        // ============================================
        async function showArcanaVenues(mood) {
            currentArcana = mood;
            const arcana = arcanaMap[mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
            const whisper = arcanaWhispers[mood] || '';
            const arcanaKey = getArcanaKey(mood);

            // Update header
            const header = document.getElementById('arcanaVenuesHeader');
            header.innerHTML = `
                <div class="arcana-card card-lg" data-arcana="${arcanaKey}">
                    <span class="corner-tr"></span>
                    <span class="corner-bl"></span>
                    <div class="card-inner">
                        <div class="arcana-symbol">${arcana.symbol}</div>
                        <div class="arcana-number">${arcana.number}</div>
                        <div class="arcana-name">${arcana.name}</div>
                        <div class="arcana-mood">${mood}</div>
                        <div class="arcana-whisper">"${whisper}"</div>
                    </div>
                </div>
            `;

            // Load venues for this arcana
            const venuesList = document.getElementById('arcanaVenuesList');
            venuesList.innerHTML = '<p class="loading-venues">Gathering venues...</p>';

            showView('arcanaVenues');

            try {
                const response = await fetch(`/arcana/${encodeURIComponent(mood)}`);
                const data = await response.json();

                if (data.error) {
                    venuesList.innerHTML = '<p class="error-state">Could not find venues...</p>';
                    return;
                }

                venuesList.innerHTML = '';

                data.venues.forEach((venue, index) => {
                    const card = document.createElement('div');
                    card.className = 'arcana-card card-sm venue-browse-card';
                    card.setAttribute('data-arcana', arcanaKey);
                    card.style.animationDelay = `${index * 50}ms`;

                    let venueLink = venue.name;
                    if (venue.website && venue.website.trim() && !venue.website.startsWith('(')) {
                        let url = venue.website;
                        if (!url.startsWith('http')) url = 'https://' + url;
                        venueLink = `<a href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${venue.name}</a>`;
                    }

                    const venueWhisper = venue.whisper || '';
                    const venueBlurb = venue.blurb || venue.whisper || '';

                    card.innerHTML = `
                        <span class="corner-tr"></span>
                        <span class="corner-bl"></span>
                        <div class="card-inner">
                            <div class="venue-name">${venueLink}</div>
                            <div class="venue-location">${venue.area || 'London'}</div>
                            <div class="venue-whisper">${venueWhisper}</div>
                            <div class="venue-blurb" style="display: none;">${venueBlurb}</div>
                        </div>
                    `;

                    // Click to expand/collapse
                    card.onclick = (e) => {
                        if (e.target.tagName === 'A') return;
                        toggleCardExpansion(card);
                    };

                    venuesList.appendChild(card);
                });

            } catch (error) {
                venuesList.innerHTML = `<p class="error-state">Something went awry: ${error.message}</p>`;
            }
        }

        function drawFromArcana() {
            if (!currentArcana) return;

            showView('draw');
            document.getElementById('drawnCard').style.display = 'flex';
            document.getElementById('revealedCard').style.display = 'none';
            document.getElementById('drawActions').style.display = 'none';
            // Face-down card shown ‚Äî user taps to reveal (currentArcana is preserved)
        }

        // ============================================
        // DRAW A CARD
        // ============================================
        async function revealCard(filteredArcana = null) {
            const drawnCard = document.getElementById('drawnCard');
            const revealedCard = document.getElementById('revealedCard');
            const drawActions = document.getElementById('drawActions');
            
            // If already revealed, do nothing
            if (drawnCard.style.display === 'none') return;
            
            // Show loading
            showLoading();
            
            try {
                const body = filteredArcana ? { arcana: filteredArcana } : {};
                
                const response = await fetch('/surprise', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Store card data
                currentCardData = data;
                
                // Get arcana info
                const arcana = arcanaMap[data.mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
                
                // Populate revealed card
                document.getElementById('cardArcanaSymbol').textContent = arcana.symbol;
                document.getElementById('cardArcanaNumber').textContent = arcana.number;
                document.getElementById('cardArcanaName').textContent = arcana.name;
                document.getElementById('cardArcanaMood').textContent = data.mood || 'A London Mystery';
                
                // Venue details
                const venueName = document.getElementById('cardVenueName');
                if (data.website && data.website.trim() && !data.website.startsWith('(')) {
                    let url = data.website;
                    if (!url.startsWith('http')) url = 'https://' + url;
                    venueName.innerHTML = `<a href="${url}" target="_blank" rel="noopener">${data.venue_name}</a>`;
                } else {
                    venueName.textContent = data.venue_name;
                }
                
                document.getElementById('cardVenueLocation').textContent = data.area || 'London';
                document.getElementById('cardVenueBlurb').textContent = data.response || '';
                
                // Set arcana glow
                revealedCard.setAttribute('data-arcana', getArcanaKey(data.mood));
                
                // Animate the reveal
                drawnCard.style.display = 'none';
                revealedCard.style.display = 'block';
                revealedCard.classList.add('card-reveal');
                
                // Show actions
                setTimeout(() => {
                    drawActions.style.display = 'flex';
                }, 500);
                
            } catch (error) {
                hideLoading();
                alert('Something went awry: ' + error.message);
            }
        }

        function drawAnother() {
            const drawnCard = document.getElementById('drawnCard');
            const revealedCard = document.getElementById('revealedCard');
            const drawActions = document.getElementById('drawActions');
            
            // Reset
            revealedCard.style.display = 'none';
            revealedCard.classList.remove('card-reveal');
            drawActions.style.display = 'none';
            drawnCard.style.display = 'flex';
            
            // Clear filtered arcana
            currentArcana = null;
        }

        function getArcanaKey(mood) {
            const keyMap = {
                'Playful & Weird': 'fool',
                'Curious Encounters': 'magician',
                'Witchy & Wild': 'priestess',
                'Folk & Intimate': 'empress',
                'The Thoughtful Stage': 'emperor',
                'Spiritual / Sacred / Mystical': 'hierophant',
                'Cabaret & Glitter': 'lovers',
                'Big Night Out': 'chariot',
                'Punchy / Protest': 'strength',
                'Contemplative & Meditative': 'hermit',
                'Global Rhythms': 'wheel',
                'Rant & Rapture': 'justice',
                'Body-Based / Movement-Led': 'hanged',
                'Grief & Grace': 'death',
                'Word & Voice': 'temperance',
                'Late-Night Lark': 'devil',
                'Melancholic Beauty': 'tower',
                'Wonder & Awe': 'star',
                'Nostalgic / Vintage / Retro': 'moon',
                'Comic Relief': 'sun',
                'Group Energy': 'judgement',
                'Queer Revelry': 'world',
                'Romanticised London': 'lark'
            };
            return keyMap[mood] || 'lark';
        }

        // ============================================
        // ASK THE LARK
        // ============================================
        async function askLark() {
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            const resultsContainer = document.getElementById('askResults');

            if (!prompt) return;

            // Mark as visited on first search
            markAsVisited();

            // Disable input
            input.disabled = true;
            document.getElementById('askButton').disabled = true;

            showLoading();
            
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                const data = await response.json();
                hideLoading();
                
                // Clear previous results
                resultsContainer.innerHTML = '';

                // Store current safety tier for care pathway calls
                currentSafetyTier = data.safety ? data.safety.tier : null;

                // =====================================================
                // SAFETY TIER HANDLING
                // =====================================================

                // Handle crisis tier - show resources FIRST
                if (data.safety && data.safety.show_crisis_resources) {
                    const crisisBox = document.createElement('div');
                    crisisBox.className = 'safety-crisis-box';
                    crisisBox.innerHTML = `
                        <div class="crisis-header">
                            <span class="crisis-icon">üïäÔ∏è</span>
                            <span class="crisis-title">YOU MATTER</span>
                        </div>
                        <p class="lark-says">${data.safety.lark_preamble || "I hear you, petal. Before anything else ‚Äî there are people who want to help hold what you're carrying right now."}</p>
                        <div class="crisis-contacts">
                            <div class="crisis-contact">
                                <span class="contact-icon">üìû</span>
                                <div class="contact-info">
                                    <span class="contact-name">Samaritans</span>
                                    <span class="contact-number"><a href="tel:116123">116 123</a></span>
                                    <span class="contact-note">Free, 24/7, no judgment</span>
                                </div>
                            </div>
                            <div class="crisis-contact">
                                <span class="contact-icon">üí¨</span>
                                <div class="contact-info">
                                    <span class="contact-name">Crisis Text Line</span>
                                    <span class="contact-number">Text <a href="sms:85258">SHOUT to 85258</a></span>
                                    <span class="contact-note">Free, 24/7, text-based</span>
                                </div>
                            </div>
                            <div class="crisis-contact">
                                <span class="contact-icon">üè•</span>
                                <div class="contact-info">
                                    <span class="contact-name">NHS Mental Health</span>
                                    <span class="contact-number"><a href="tel:111">111</a> (press 2)</span>
                                    <span class="contact-note">24/7 urgent support</span>
                                </div>
                            </div>
                        </div>
                        <p class="venue-offer">If you'd still like somewhere gentle to go, I can offer that too...</p>
                    `;
                    resultsContainer.appendChild(crisisBox);
                }

                // Handle care pathway (Tier 2/3) - show preamble + texture cards or choice buttons
                if (data.safety && data.safety.show_care_pathway && (data.safety.textures || data.safety.care_choices)) {
                    renderCarePathway(data.safety, resultsContainer);
                    // Re-enable input
                    input.disabled = false;
                    document.getElementById('askButton').disabled = false;
                    return;  // Wait for user choice
                }

                // Handle null state - show presence and options
                if (data.null_state && data.null_state.is_null) {
                    renderNullState(data.null_state, resultsContainer);
                    // Re-enable input
                    input.disabled = false;
                    document.getElementById('askButton').disabled = false;
                    input.value = '';
                    return;
                }

                // =====================================================
                // CONVERSATIONAL FALLBACKS (location-only, vague, no match)
                // Show as prompt text, not as venue cards
                // =====================================================
                if (data.needs_clarification && data.responses && data.responses.length > 0) {
                    const clarificationText = data.responses[0].text;

                    const clarificationSection = document.createElement('div');
                    clarificationSection.className = 'lark-clarification';
                    clarificationSection.innerHTML = `
                        <p class="lark-asks">${clarificationText}</p>
                    `;
                    resultsContainer.appendChild(clarificationSection);

                    // Re-enable input and clear it for the follow-up
                    input.disabled = false;
                    document.getElementById('askButton').disabled = false;
                    input.value = '';
                    input.placeholder = 'Tell me more...';
                    input.focus();
                    return;
                }

                // =====================================================
                // VENUE RENDERING
                // =====================================================
                if (data.responses && data.responses.length > 0) {
                    // Show Lark's opening line (preamble) if present
                    if (data.opening_line) {
                        const preambleSection = document.createElement('div');
                        preambleSection.className = 'lark-preamble-section';
                        preambleSection.innerHTML = `
                            <p class="lark-opening-line">"${data.opening_line}"</p>
                            <p class="user-whispered">You whispered: <em>${prompt}</em></p>
                        `;
                        resultsContainer.appendChild(preambleSection);
                    }

                    // Show Lark's intro text if present (legacy)
                    if (data.intro) {
                        const intro = document.createElement('p');
                        intro.className = 'lark-intro';
                        intro.textContent = data.intro;
                        resultsContainer.appendChild(intro);
                    }

                    // Render venue cards with staggered animation
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            const card = createVenueCard(resp, resp.arcana || data.mood);
                            resultsContainer.appendChild(card);

                            // After all venues, add soft footer if needed (Tier 2)
                            if (index === data.responses.length - 1) {
                                if (data.safety && data.safety.show_soft_footer) {
                                    const softFooter = document.createElement('div');
                                    softFooter.className = 'safety-soft-footer';
                                    softFooter.innerHTML = `
                                        And if you need more than a place: <a href="/resources">Resources</a>
                                    `;
                                    resultsContainer.appendChild(softFooter);
                                }
                            }
                        }, index * 200);
                    });

                } else if (!data.safety?.show_crisis_resources) {
                    // Empty state - no venues found (and not crisis)
                    resultsContainer.innerHTML += `
                        <div class="empty-state">
                            <p>The wind found no doors tonight, petal.</p>
                            <p class="empty-subtext">Try another path, or speak differently.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                hideLoading();
                resultsContainer.innerHTML = `<div class="error-state">Something went awry: ${error.message}</div>`;
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('askButton').disabled = false;
            input.value = '';
            input.focus();
        }

        function createVenueCard(venue, mood) {
            const card = document.createElement('div');
            const arcana = arcanaMap[mood] || { number: '‚ú¶', name: 'THE LARK', symbol: '‚ù¶' };
            const arcanaKey = getArcanaKey(mood);
            const whisper = venue.whisper || arcanaWhispers[mood] || '';

            card.className = 'arcana-card card-sm venue-card-result';
            card.setAttribute('data-arcana', arcanaKey);

            // Store venue data for expansion
            card.dataset.venueBlurb = venue.text || '';
            card.dataset.venueWebsite = venue.website || '';

            let venueLink = venue.venue_name;
            if (venue.website && venue.website.trim() && !venue.website.startsWith('(')) {
                let url = venue.website;
                if (!url.startsWith('http')) url = 'https://' + url;
                venueLink = `<a href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${venue.venue_name}</a>`;
            }

            card.innerHTML = `
                <span class="corner-tr"></span>
                <span class="corner-bl"></span>
                <div class="card-inner">
                    <div class="arcana-symbol">${arcana.symbol}</div>
                    <div class="arcana-number">${arcana.number}</div>
                    <div class="arcana-name">${arcana.name}</div>
                    <div class="arcana-mood">${mood}</div>
                    <div class="arcana-divider"></div>
                    <div class="venue-section">
                        <div class="venue-name">${venueLink}</div>
                        <div class="venue-whisper">${whisper}</div>
                        <div class="venue-blurb" style="display: none;">${venue.text || ''}</div>
                    </div>
                </div>
            `;

            // Click to expand/collapse
            card.onclick = (e) => {
                if (e.target.tagName === 'A') return; // Don't toggle if clicking link
                toggleCardExpansion(card);
            };

            return card;
        }

        function toggleCardExpansion(card) {
            const isExpanded = card.classList.contains('card-lg');
            const whisperEl = card.querySelector('.venue-whisper');
            const blurbEl = card.querySelector('.venue-blurb');

            if (isExpanded) {
                // Collapse
                card.classList.remove('card-lg');
                card.classList.add('card-sm');
                if (whisperEl) whisperEl.style.display = 'block';
                if (blurbEl) blurbEl.style.display = 'none';
            } else {
                // Expand
                card.classList.remove('card-sm');
                card.classList.add('card-lg');
                if (whisperEl) whisperEl.style.display = 'none';
                if (blurbEl) blurbEl.style.display = 'block';
            }
        }

        // ============================================
        // CARE PATHWAY RENDERING
        // ============================================
        function renderCarePathway(safety, container) {
            const careContainer = document.createElement('div');
            careContainer.className = 'care-pathway-container';

            // Preamble
            const preamble = document.createElement('p');
            preamble.className = 'care-preamble';
            preamble.textContent = safety.lark_preamble || "I hear you.";
            careContainer.appendChild(preamble);

            // NEW: Render texture cards if use_texture_cards is true
            if (safety.use_texture_cards && safety.textures && safety.textures.length > 0) {
                const texturesDiv = document.createElement('div');
                texturesDiv.className = 'texture-cards';

                safety.textures.forEach(texture => {
                    const card = document.createElement('div');
                    card.className = 'texture-card';
                    card.onclick = () => handleTextureChoice(texture.texture_key, safety.tier);

                    // Add corner flourishes (like venue cards)
                    const cornerTR = document.createElement('span');
                    cornerTR.className = 'corner-tr';
                    const cornerBL = document.createElement('span');
                    cornerBL.className = 'corner-bl';
                    card.appendChild(cornerTR);
                    card.appendChild(cornerBL);

                    // Icon
                    const icon = document.createElement('div');
                    icon.className = 'texture-icon';
                    icon.textContent = texture.icon || '‚ú¶';
                    card.appendChild(icon);

                    // Texture phrase
                    const phrase = document.createElement('div');
                    phrase.className = 'texture-phrase';
                    phrase.textContent = texture.texture;
                    card.appendChild(phrase);

                    texturesDiv.appendChild(card);
                });

                careContainer.appendChild(texturesDiv);
            }
            // LEGACY: Render choice buttons if no texture cards
            else if (safety.care_choices) {
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'care-choices';

                safety.care_choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'care-choice-btn';
                    btn.textContent = choice.label;
                    btn.onclick = () => handleCareChoice(choice.arcana, safety.tier);
                    choicesDiv.appendChild(btn);
                });

                careContainer.appendChild(choicesDiv);
            }

            // Resources footer for Tier 3 (distress) - warmer styling
            if (safety.tier === 'distress') {
                const footer = document.createElement('div');
                footer.className = 'resources-footer resources-footer-warm';
                footer.innerHTML = `
                    <p class="resources-footer-text">And if you need more than a place tonight, there are people who can hold that too.</p>
                    <div class="resources-footer-contacts">
                        <span><strong>Samaritans:</strong> <a href="tel:116123">116 123</a> (free, 24/7)</span>
                        <span><strong>Shout:</strong> Text <a href="sms:85258">SHOUT to 85258</a></span>
                        <span><a href="https://mind.org.uk" target="_blank" rel="noopener">mind.org.uk</a></span>
                    </div>
                `;
                careContainer.appendChild(footer);
            }

            container.appendChild(careContainer);
        }

        // NEW: Handle texture card selection
        async function handleTextureChoice(textureKey, tier) {
            const resultsContainer = document.getElementById('askResults');
            showLoading();

            try {
                const response = await fetch('/care-pathway', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texture_key: textureKey, tier })
                });

                const data = await response.json();
                hideLoading();

                if (data.error) {
                    resultsContainer.innerHTML = `<div class="error-state">${data.error}</div>`;
                    return;
                }

                // Clear the care pathway UI
                resultsContainer.innerHTML = '';

                // Render venues
                if (data.responses && data.responses.length > 0) {
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            const card = createVenueCard(resp, resp.arcana || data.mood);
                            resultsContainer.appendChild(card);

                            // After all venues, add appropriate footer
                            if (index === data.responses.length - 1) {
                                // Soft footer for Tier 2
                                if (data.safety && data.safety.show_soft_footer) {
                                    const softFooter = document.createElement('div');
                                    softFooter.className = 'safety-soft-footer';
                                    softFooter.innerHTML = `
                                        And if you need more than a place: <a href="/resources">Resources</a>
                                    `;
                                    resultsContainer.appendChild(softFooter);
                                }

                                // Resources footer for Tier 3 - warm version
                                if (data.safety && (data.safety.resources_footer || tier === 'distress')) {
                                    const footer = document.createElement('div');
                                    footer.className = 'resources-footer resources-footer-warm';
                                    footer.innerHTML = `
                                        <p class="resources-footer-text">And if you need more than a place tonight, there are people who can hold that too.</p>
                                        <div class="resources-footer-contacts">
                                            <span><strong>Samaritans:</strong> <a href="tel:116123">116 123</a> (free, 24/7)</span>
                                            <span><strong>Shout:</strong> Text <a href="sms:85258">SHOUT to 85258</a></span>
                                            <span><a href="https://mind.org.uk" target="_blank" rel="noopener">mind.org.uk</a></span>
                                        </div>
                                    `;
                                    resultsContainer.appendChild(footer);
                                }
                            }
                        }, index * 200);
                    });
                } else {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>The wind found no doors tonight, petal.</p>
                            <p class="empty-subtext">Try another path, or speak differently.</p>
                        </div>
                    `;
                }

            } catch (error) {
                hideLoading();
                resultsContainer.innerHTML = `<div class="error-state">Something went awry: ${error.message}</div>`;
            }
        }

        // LEGACY: Handle care choice button selection (for backward compatibility)
        async function handleCareChoice(arcana, tier) {
            const resultsContainer = document.getElementById('askResults');
            showLoading();

            try {
                const response = await fetch('/care-pathway', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ arcana, tier })
                });

                const data = await response.json();
                hideLoading();

                if (data.error) {
                    resultsContainer.innerHTML = `<div class="error-state">${data.error}</div>`;
                    return;
                }

                // Clear the care pathway UI
                resultsContainer.innerHTML = '';

                // Render venues
                if (data.responses && data.responses.length > 0) {
                    data.responses.forEach((resp, index) => {
                        setTimeout(() => {
                            const card = createVenueCard(resp, resp.arcana || data.mood);
                            resultsContainer.appendChild(card);

                            // After all venues, add appropriate footer
                            if (index === data.responses.length - 1) {
                                // Soft footer for Tier 2
                                if (data.safety && data.safety.show_soft_footer) {
                                    const softFooter = document.createElement('div');
                                    softFooter.className = 'safety-soft-footer';
                                    softFooter.innerHTML = `
                                        And if you need more than a place: <a href="/resources">Resources</a>
                                    `;
                                    resultsContainer.appendChild(softFooter);
                                }

                                // Resources footer for Tier 3
                                if (data.safety && data.safety.resources_footer) {
                                    const footer = document.createElement('div');
                                    footer.className = 'resources-footer resources-footer-warm';
                                    footer.innerHTML = `
                                        <p class="resources-footer-text">${data.safety.resources_footer}</p>
                                        <div class="resources-footer-contacts">
                                            <span><strong>Samaritans:</strong> <a href="tel:116123">116 123</a> (free, 24/7)</span>
                                            <span><strong>Shout:</strong> Text <a href="sms:85258">SHOUT to 85258</a></span>
                                            <span><a href="https://mind.org.uk" target="_blank" rel="noopener">mind.org.uk</a></span>
                                        </div>
                                    `;
                                    resultsContainer.appendChild(footer);
                                }
                            }
                        }, index * 200);
                    });
                } else {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>The wind found no doors tonight, petal.</p>
                            <p class="empty-subtext">Try another path, or speak differently.</p>
                        </div>
                    `;
                }

            } catch (error) {
                hideLoading();
                resultsContainer.innerHTML = `<div class="error-state">Something went awry: ${error.message}</div>`;
            }
        }

        // ============================================
        // NULL STATE RENDERING
        // ============================================
        function renderNullState(nullState, container) {
            const nullContainer = document.createElement('div');
            nullContainer.className = 'null-state-container';

            // Preamble - warm presence
            const preamble = document.createElement('p');
            preamble.className = 'null-preamble';
            preamble.textContent = nullState.preamble;
            nullContainer.appendChild(preamble);

            // Choice buttons
            const choicesDiv = document.createElement('div');
            choicesDiv.className = 'null-choices';

            nullState.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'null-choice-btn';
                btn.textContent = choice.label;
                btn.onclick = () => handleNullChoice(choice.action);
                choicesDiv.appendChild(btn);
            });

            nullContainer.appendChild(choicesDiv);
            container.appendChild(nullContainer);
        }

        function handleNullChoice(action) {
            switch (action) {
                case 'draw_random':
                    // Draw a random card (using therapeutic arcana if appropriate)
                    choosePath('draw');
                    break;
                case 'browse':
                    // Navigate to browse view
                    choosePath('browse');
                    break;
                case 'clear_input':
                    // Clear search and refocus
                    document.getElementById('askResults').innerHTML = '';
                    const input = document.getElementById('userInput');
                    input.value = '';
                    input.focus();
                    break;
            }
        }

        // ============================================
        // CRISIS HANDLING (legacy - kept for compatibility)
        // ============================================
        function renderCrisisResponse(crisisData) {
            const container = document.getElementById('crisisContent');
            container.innerHTML = `
                <div class="crisis-message">
                    <p class="crisis-intro">${crisisData.intro || "I hear something in your words that makes me want to reach beyond venues tonight."}</p>
                    <div class="crisis-resources">
                        <p class="resources-label">These humans know how to hold what you're carrying:</p>
                        <ul class="resources-list">
                            <li><strong>Samaritans:</strong> 116 123 (free, 24/7)</li>
                            <li><strong>Crisis Text Line:</strong> Text SHOUT to 85258</li>
                            <li><strong>NHS Urgent:</strong> 111, option 2</li>
                        </ul>
                    </div>
                    <p class="crisis-closing">${crisisData.closing || "I'm here, but I'm not enough for all pain. Let others help carry this."}</p>
                </div>
            `;
            showView('crisis');
        }

        function renderDistressResponse(data) {
            const resultsContainer = document.getElementById('askResults');
            
            // Show resources first
            const resourcesDiv = document.createElement('div');
            resourcesDiv.className = 'distress-resources';
            resourcesDiv.innerHTML = `
                <p class="distress-intro">${data.crisis_response.intro || "I sense heaviness in your words."}</p>
                <div class="resources-compact">
                    <span>Samaritans: 116 123</span> ¬∑ <span>Text SHOUT to 85258</span>
                </div>
            `;
            resultsContainer.appendChild(resourcesDiv);
            
            // Then show venues if present
            if (data.responses && data.responses.length > 0) {
                const venueIntro = document.createElement('p');
                venueIntro.className = 'venue-intro-after-resources';
                venueIntro.textContent = data.crisis_response.venue_intro || "And if you still want a place to sit with this feeling:";
                resultsContainer.appendChild(venueIntro);
                
                data.responses.forEach((resp, index) => {
                    setTimeout(() => {
                        const card = createVenueCard(resp, resp.arcana || data.mood);
                        resultsContainer.appendChild(card);
                    }, index * 200);
                });
            }
        }

        // ============================================
        // LOADING
        // ============================================
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Enter to submit in ask view
            if (e.key === 'Enter' && !e.shiftKey && currentView === 'ask') {
                const input = document.getElementById('userInput');
                if (document.activeElement === input) {
                    e.preventDefault();
                    askLark();
                }
            }
            
            // Escape to go back
            if (e.key === 'Escape' && currentView !== 'ask') {
                if (currentView === 'arcanaVenues') {
                    showView('browse');
                } else {
                    returnToEntrance();
                }
            }
        });

        // ============================================
        // INIT
        // ============================================
        // ============================================
        // TIME-OF-DAY GREETINGS
        // ============================================
        const timeGreetings = {
            morning: [
                "The city stirs‚Ä¶ but some doors only open for early hearts.",
                "Morning light spills secrets if you rise with it.",
                "You're up before the spell breaks. Good.",
                "Early riser. The city rewards that.",
                "Dawn seekers find different doors.",
                "The morning holds quieter magic. What are you after?"
            ],
            afternoon: [
                "While the city hurries, something slower waits.",
                "You looked away from your inbox. The city noticed.",
                "Boredom is a key. Want to see where it fits?",
                "Midday wanderer. What calls to you?",
                "The afternoon hums with possibility.",
                "Between meetings, between worlds. What are you seeking?"
            ],
            evening: [
                "Evening descends. Some lights glow for those who follow feeling.",
                "The night is gathering herself. Want in?",
                "Doors open differently after dusk.",
                "The city changes after sunset. So might you.",
                "Evening unfolds. What kind of night are you after?",
                "Twilight seekers find the best corners."
            ],
            lateNight: [
                "The clocks are quiet. But something's still humming.",
                "You're awake. So is the city's underside.",
                "The veil thins after midnight. Step through.",
                "Night owl. The city has secrets for you.",
                "The small hours hold different doors.",
                "Still up? So is she. What are you seeking?"
            ]
        };

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 18) return 'afternoon';
            if (hour >= 18 && hour < 24) return 'evening';
            return 'lateNight';
        }

        function setTimeGreeting() {
            const period = getTimeOfDay();
            const greetings = timeGreetings[period];
            const greeting = greetings[Math.floor(Math.random() * greetings.length)];
            const el = document.getElementById('entranceGreeting');
            if (el) el.textContent = greeting;
        }

        // ============================================
        // CYCLING PLACEHOLDER EXAMPLES
        // ============================================
        const placeholderExamples = [
            // Feelings / Moods
            "cosy, with candles and wine...",
            "I want to feel alive...",
            "somewhere to think...",
            "I need to move my body...",
            "something weird and wonderful...",
            "I want to laugh...",
            "somewhere dark and intimate...",
            "I need stillness...",
            "take me somewhere strange...",
            "I'm feeling tender...",
            // Specific Vibes
            "witchy...",
            "jazz and candlelight...",
            "queer night out...",
            "live music...",
            "poetry...",
            "grief and grace...",
            "cabaret...",
            "late night...",
            // Emotional States
            "I don't know what I want...",
            "surprise me...",
            "somewhere I can be alone but not lonely...",
            "I need to feel something...",
            // Combined
            "cosy in Brixton...",
            "something weird in Peckham...",
            "dancing in Hackney..."
        ];

        let placeholderIndex = 0;
        let placeholderInterval = null;

        function cyclePlaceholder() {
            const input = document.getElementById('entranceInput');
            if (!input || document.activeElement === input) return;

            // Fade out
            input.style.transition = 'opacity 0.3s ease';
            input.style.opacity = '0.3';

            setTimeout(() => {
                placeholderIndex = (placeholderIndex + 1) % placeholderExamples.length;
                input.placeholder = placeholderExamples[placeholderIndex];
                // Fade in
                input.style.opacity = '1';
            }, 300);
        }

        function startPlaceholderCycle() {
            // Randomize starting point
            placeholderIndex = Math.floor(Math.random() * placeholderExamples.length);
            const input = document.getElementById('entranceInput');
            if (input) input.placeholder = placeholderExamples[placeholderIndex];

            // Cycle every 3.5 seconds
            placeholderInterval = setInterval(cyclePlaceholder, 3500);
        }

        function stopPlaceholderCycleEntrance() {
            if (placeholderInterval) {
                clearInterval(placeholderInterval);
                placeholderInterval = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Entrance-first: show the search-first entrance
            showView('entrance');

            // Set time-of-day greeting
            setTimeGreeting();

            // Start placeholder cycling
            startPlaceholderCycle();

            // Pause cycling when input is focused
            const entranceInput = document.getElementById('entranceInput');
            entranceInput.addEventListener('focus', stopPlaceholderCycleEntrance);
            entranceInput.addEventListener('blur', () => {
                if (!entranceInput.value) startPlaceholderCycle();
            });

            // Enter key support for entrance search
            entranceInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    entranceAsk();
                }
            });

            // Enter key support for ask view search
            document.getElementById('userInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    askLark();
                }
            });
        });
    </script>
</body>
</html>
